
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
      <link rel="icon" href="../../../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.4.0, mkdocs-material-8.5.3">
    
    
      
        <title>Identity and Access Management - EKS Best Practices Guides</title>
      
    
    
      <link rel="stylesheet" href="../../../assets/stylesheets/main.7a952b86.min.css">
      
        
        <link rel="stylesheet" href="../../../assets/stylesheets/palette.cbb835fc.min.css">
        
      
      

    
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
    <script>__md_scope=new URL("../../..",location),__md_hash=e=>[...e].reduce((e,_)=>(e<<5)-e+_.charCodeAt(0),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      
  


  
  


  <script id="__analytics">function __md_analytics(){function n(){dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],n("js",new Date),n("config","G-VQGL8B2FH8"),document.addEventListener("DOMContentLoaded",function(){document.forms.search&&document.forms.search.query.addEventListener("blur",function(){this.value&&n("event","search",{search_term:this.value})}),document$.subscribe(function(){var a=document.forms.feedback;if(void 0!==a)for(var e of a.querySelectorAll("[type=submit]"))e.addEventListener("click",function(e){e.preventDefault();var t=document.location.pathname,e=this.getAttribute("data-md-value");n("event","feedback",{page:t,data:e}),a.firstElementChild.disabled=!0;e=a.querySelector(".md-feedback__note [data-md-value='"+e+"']");e&&(e.hidden=!1)}),a.hidden=!1}),location$.subscribe(function(e){n("config","G-VQGL8B2FH8",{page_path:e.pathname})})});var e=document.createElement("script");e.async=!0,e.src="https://www.googletagmanager.com/gtag/js?id=G-VQGL8B2FH8",document.getElementById("__analytics").insertAdjacentElement("afterEnd",e)}</script>

  
    <script>"undefined"!=typeof __md_analytics&&__md_analytics()</script>
  

    
    
    
  </head>
  
  
    
    
    
    
    
    <body dir="ltr" data-md-color-scheme="" data-md-color-primary="none" data-md-color-accent="none">
  
    
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#identity-and-access-management" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

<header class="md-header" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href="../../.." title="EKS Best Practices Guides" class="md-header__button md-logo" aria-label="EKS Best Practices Guides" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54Z"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2Z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            EKS Best Practices Guides
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              Identity and Access Management
            
          </span>
        </div>
      </div>
    </div>
    
    
    
      <label class="md-header__button md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
      </label>
      <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41Z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
      <div class="md-header__source">
        <a href="https://github.com/aws/aws-eks-best-practices" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 496 512"><!--! Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc.--><path d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6zm-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3zm44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9zM244.8 8C106.1 8 0 113.3 0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8zM97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1zm-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7zm32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1zm-11.4-14.7c-1.6 1-1.6 3.6 0 5.9 1.6 2.3 4.3 3.3 5.6 2.3 1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2z"/></svg>
  </div>
  <div class="md-source__repository">
    aws/aws-eks-best-practices
  </div>
</a>
      </div>
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    


<nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../../.." title="EKS Best Practices Guides" class="md-nav__button md-logo" aria-label="EKS Best Practices Guides" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54Z"/></svg>

    </a>
    EKS Best Practices Guides
  </label>
  
    <div class="md-nav__source">
      <a href="https://github.com/aws/aws-eks-best-practices" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 496 512"><!--! Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc.--><path d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6zm-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3zm44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9zM244.8 8C106.1 8 0 113.3 0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8zM97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1zm-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7zm32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1zm-11.4-14.7c-1.6 1-1.6 3.6 0 5.9 1.6 2.3 4.3 3.3 5.6 2.3 1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2z"/></svg>
  </div>
  <div class="md-source__repository">
    aws/aws-eks-best-practices
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_1" type="checkbox" id="__nav_1" >
      
      
      
      
        <label class="md-nav__link" for="__nav_1">
          Guides
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Guides" data-md-level="1">
        <label class="md-nav__title" for="__nav_1">
          <span class="md-nav__icon md-icon"></span>
          Guides
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../.." class="md-nav__link">
        Introduction
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
    
  
  
    
    <li class="md-nav__item md-nav__item--active md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_2" type="checkbox" id="__nav_2" checked>
      
      
      
      
        <label class="md-nav__link" for="__nav_2">
          Security
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Security" data-md-level="1">
        <label class="md-nav__title" for="__nav_2">
          <span class="md-nav__icon md-icon"></span>
          Security
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../" class="md-nav__link">
        Home
      </a>
    </li>
  

            
          
            
              
  
  
    
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" data-md-toggle="toc" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          Identity and Access Management
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        Identity and Access Management
      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#controlling-access-to-eks-clusters" class="md-nav__link">
    Controlling Access to EKS Clusters
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#recommendations" class="md-nav__link">
    Recommendations
  </a>
  
    <nav class="md-nav" aria-label="Recommendations">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#dont-use-a-service-account-token-for-authentication" class="md-nav__link">
    Don't use a service account token for authentication
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#employ-least-privileged-access-to-aws-resources" class="md-nav__link">
    Employ least privileged access to AWS Resources
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#use-iam-roles-when-multiple-users-need-identical-access-to-the-cluster" class="md-nav__link">
    Use IAM Roles when multiple users need identical access to the cluster
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#employ-least-privileged-access-when-creating-rolebindings-and-clusterrolebindings" class="md-nav__link">
    Employ least privileged access when creating RoleBindings and ClusterRoleBindings
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#make-the-eks-cluster-endpoint-private" class="md-nav__link">
    Make the EKS Cluster Endpoint private
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#create-the-cluster-with-a-dedicated-iam-role" class="md-nav__link">
    Create the cluster with a dedicated IAM role
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#use-tools-to-make-changes-to-the-aws-auth-configmap" class="md-nav__link">
    Use tools to make changes to the aws-auth ConfigMap
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#regularly-audit-access-to-the-cluster" class="md-nav__link">
    Regularly audit access to the cluster
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#alternative-approaches-to-authentication-and-access-management" class="md-nav__link">
    Alternative Approaches to Authentication and Access Management
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#additional-resources" class="md-nav__link">
    Additional Resources
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#pods-identities" class="md-nav__link">
    Pods Identities
  </a>
  
    <nav class="md-nav" aria-label="Pods Identities">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#kubernetes-service-accounts" class="md-nav__link">
    Kubernetes Service Accounts
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#iam-roles-for-service-accounts-irsa" class="md-nav__link">
    IAM Roles for Service Accounts (IRSA)
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#recommendations_1" class="md-nav__link">
    Recommendations
  </a>
  
    <nav class="md-nav" aria-label="Recommendations">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#update-the-aws-node-daemonset-to-use-irsa" class="md-nav__link">
    Update the aws-node daemonset to use IRSA
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#restrict-access-to-the-instance-profile-assigned-to-the-worker-node" class="md-nav__link">
    Restrict access to the instance profile assigned to the worker node
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#scope-the-iam-role-trust-policy-for-irsa-to-the-service-account-name" class="md-nav__link">
    Scope the IAM Role trust policy for IRSA to the service account name
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#when-your-application-needs-access-to-imds-use-imdsv2-and-increase-the-hop-limit-on-ec2-instances-to-2" class="md-nav__link">
    When your application needs access to IMDS, use IMDSv2 and increase the hop limit on EC2 instances to 2
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#disable-auto-mounting-of-service-account-tokens" class="md-nav__link">
    Disable auto-mounting of service account tokens
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#use-dedicated-service-accounts-for-each-application" class="md-nav__link">
    Use dedicated service accounts for each application
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#run-the-application-as-a-non-root-user" class="md-nav__link">
    Run the application as a non-root user
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#grant-least-privileged-access-to-applications" class="md-nav__link">
    Grant least privileged access to applications
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#review-and-revoke-unnecessary-anonymous-access" class="md-nav__link">
    Review and revoke unnecessary anonymous access
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#alternative-approaches" class="md-nav__link">
    Alternative approaches
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../pods/" class="md-nav__link">
        Pod Security
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../multitenancy/" class="md-nav__link">
        Multi-tenancy
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../detective/" class="md-nav__link">
        Detective Controls
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../network/" class="md-nav__link">
        Network Security
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../data/" class="md-nav__link">
        Data Encryption and Secrets Management
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../runtime/" class="md-nav__link">
        Runtime Security
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../hosts/" class="md-nav__link">
        Infrastructure Security
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../compliance/" class="md-nav__link">
        Regulatory Compliance
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../incidents/" class="md-nav__link">
        Incident Response and Forensics
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../image/" class="md-nav__link">
        Image Security
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_3" type="checkbox" id="__nav_3" >
      
      
      
      
        <label class="md-nav__link" for="__nav_3">
          Cluster Autoscaling
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Cluster Autoscaling" data-md-level="1">
        <label class="md-nav__title" for="__nav_3">
          <span class="md-nav__icon md-icon"></span>
          Cluster Autoscaling
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../karpenter/" class="md-nav__link">
        Karpenter
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../cluster-autoscaling/" class="md-nav__link">
        Cluster-Autoscaler
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_4" type="checkbox" id="__nav_4" >
      
      
      
      
        <label class="md-nav__link" for="__nav_4">
          Reliability
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Reliability" data-md-level="1">
        <label class="md-nav__title" for="__nav_4">
          <span class="md-nav__icon md-icon"></span>
          Reliability
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../reliability/docs/" class="md-nav__link">
        Home
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../reliability/docs/application/" class="md-nav__link">
        Applications
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../reliability/docs/controlplane/" class="md-nav__link">
        Control Plane
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../reliability/docs/dataplane/" class="md-nav__link">
        Data Plane
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../reliability/docs/networkmanagement/" class="md-nav__link">
        Network
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_5" type="checkbox" id="__nav_5" >
      
      
      
      
        <label class="md-nav__link" for="__nav_5">
          Windows Containers
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Windows Containers" data-md-level="1">
        <label class="md-nav__title" for="__nav_5">
          <span class="md-nav__icon md-icon"></span>
          Windows Containers
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../windows/docs/ami/" class="md-nav__link">
        AMI Management
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../windows/docs/gmsa/" class="md-nav__link">
        gMSA for Windows Containers
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../windows/docs/hardening/" class="md-nav__link">
        Windows Server Hardening
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../windows/docs/heterogeneous/" class="md-nav__link">
        Running Mixed Workloads
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../windows/docs/images/" class="md-nav__link">
        Scanning Windows Images
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../windows/docs/licensing/" class="md-nav__link">
        Windows Versions and Licensing
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../windows/docs/logging/" class="md-nav__link">
        Logging
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../windows/docs/monitoring/" class="md-nav__link">
        Monitoring Windows Containers
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../windows/docs/networking/" class="md-nav__link">
        Windows Networking
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../windows/docs/oom/" class="md-nav__link">
        Memory and Systems Management
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../windows/docs/patching/" class="md-nav__link">
        Infrastructure Management
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../windows/docs/scheduling/" class="md-nav__link">
        Scheduling
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../windows/docs/security/" class="md-nav__link">
        Pod Security for Windows Containers
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../windows/docs/storage/" class="md-nav__link">
        Storage Options
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_6" type="checkbox" id="__nav_6" >
      
      
      
      
        <label class="md-nav__link" for="__nav_6">
          Networking
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Networking" data-md-level="1">
        <label class="md-nav__title" for="__nav_6">
          <span class="md-nav__icon md-icon"></span>
          Networking
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../networking/index/" class="md-nav__link">
        Home
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../networking/subnets/" class="md-nav__link">
        VPC and Subnet Considerations
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../networking/vpc-cni/" class="md-nav__link">
        Amazon VPC CNI
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../networking/prefix-mode/" class="md-nav__link">
        Prefix Mode
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../networking/ipv6/" class="md-nav__link">
        Running IPv6 Clusters
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../networking/sgpp/" class="md-nav__link">
        Security Groups per Pod
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../networking/custom-networking/" class="md-nav__link">
        Custom Networking
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../networking/loadbalancing/loadbalancing/" class="md-nav__link">
        Load Balancing
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#controlling-access-to-eks-clusters" class="md-nav__link">
    Controlling Access to EKS Clusters
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#recommendations" class="md-nav__link">
    Recommendations
  </a>
  
    <nav class="md-nav" aria-label="Recommendations">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#dont-use-a-service-account-token-for-authentication" class="md-nav__link">
    Don't use a service account token for authentication
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#employ-least-privileged-access-to-aws-resources" class="md-nav__link">
    Employ least privileged access to AWS Resources
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#use-iam-roles-when-multiple-users-need-identical-access-to-the-cluster" class="md-nav__link">
    Use IAM Roles when multiple users need identical access to the cluster
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#employ-least-privileged-access-when-creating-rolebindings-and-clusterrolebindings" class="md-nav__link">
    Employ least privileged access when creating RoleBindings and ClusterRoleBindings
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#make-the-eks-cluster-endpoint-private" class="md-nav__link">
    Make the EKS Cluster Endpoint private
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#create-the-cluster-with-a-dedicated-iam-role" class="md-nav__link">
    Create the cluster with a dedicated IAM role
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#use-tools-to-make-changes-to-the-aws-auth-configmap" class="md-nav__link">
    Use tools to make changes to the aws-auth ConfigMap
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#regularly-audit-access-to-the-cluster" class="md-nav__link">
    Regularly audit access to the cluster
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#alternative-approaches-to-authentication-and-access-management" class="md-nav__link">
    Alternative Approaches to Authentication and Access Management
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#additional-resources" class="md-nav__link">
    Additional Resources
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#pods-identities" class="md-nav__link">
    Pods Identities
  </a>
  
    <nav class="md-nav" aria-label="Pods Identities">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#kubernetes-service-accounts" class="md-nav__link">
    Kubernetes Service Accounts
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#iam-roles-for-service-accounts-irsa" class="md-nav__link">
    IAM Roles for Service Accounts (IRSA)
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#recommendations_1" class="md-nav__link">
    Recommendations
  </a>
  
    <nav class="md-nav" aria-label="Recommendations">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#update-the-aws-node-daemonset-to-use-irsa" class="md-nav__link">
    Update the aws-node daemonset to use IRSA
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#restrict-access-to-the-instance-profile-assigned-to-the-worker-node" class="md-nav__link">
    Restrict access to the instance profile assigned to the worker node
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#scope-the-iam-role-trust-policy-for-irsa-to-the-service-account-name" class="md-nav__link">
    Scope the IAM Role trust policy for IRSA to the service account name
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#when-your-application-needs-access-to-imds-use-imdsv2-and-increase-the-hop-limit-on-ec2-instances-to-2" class="md-nav__link">
    When your application needs access to IMDS, use IMDSv2 and increase the hop limit on EC2 instances to 2
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#disable-auto-mounting-of-service-account-tokens" class="md-nav__link">
    Disable auto-mounting of service account tokens
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#use-dedicated-service-accounts-for-each-application" class="md-nav__link">
    Use dedicated service accounts for each application
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#run-the-application-as-a-non-root-user" class="md-nav__link">
    Run the application as a non-root user
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#grant-least-privileged-access-to-applications" class="md-nav__link">
    Grant least privileged access to applications
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#review-and-revoke-unnecessary-anonymous-access" class="md-nav__link">
    Review and revoke unnecessary anonymous access
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#alternative-approaches" class="md-nav__link">
    Alternative approaches
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  

  <a href="https://github.com/aws/aws-eks-best-practices/edit/master/docs/security/docs/iam.md" title="Edit this page" class="md-content__button md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20.71 7.04c.39-.39.39-1.04 0-1.41l-2.34-2.34c-.37-.39-1.02-.39-1.41 0l-1.84 1.83 3.75 3.75M3 17.25V21h3.75L17.81 9.93l-3.75-3.75L3 17.25Z"/></svg>
  </a>


<h1 id="identity-and-access-management">Identity and Access Management<a class="headerlink" href="#identity-and-access-management" title="Permanent link">&para;</a></h1>
<p><a href="https://docs.aws.amazon.com/IAM/latest/UserGuide/introduction.html">Identity and Access Management</a> (IAM) is an AWS service that performs two essential functions: Authentication and Authorization.  Authentication involves the verification of a identity whereas authorization governs the actions that can be performed by AWS resources.  Within AWS, a resource can be another AWS service, e.g. EC2, or an AWS <a href="https://docs.aws.amazon.com/IAM/latest/UserGuide/intro-structure.html#intro-structure-principal">principal</a> such as an <a href="https://docs.aws.amazon.com/IAM/latest/UserGuide/id.html#id_iam-users">IAM User</a> or <a href="https://docs.aws.amazon.com/IAM/latest/UserGuide/id.html#id_iam-roles">Role</a>.  The rules governing the actions that a resource is allowed to perform are expressed as <a href="https://docs.aws.amazon.com/IAM/latest/UserGuide/access_policies.html">IAM policies</a>.  </p>
<h2 id="controlling-access-to-eks-clusters">Controlling Access to EKS Clusters<a class="headerlink" href="#controlling-access-to-eks-clusters" title="Permanent link">&para;</a></h2>
<p>The Kubernetes project supports a variety of different strategies to authenticate requests to the kube-apiserver service, e.g. Bearer Tokens, X.509 certificates, OIDC, etc. EKS currently has native support for <a href="https://kubernetes.io/docs/reference/access-authn-authz/authentication/#webhook-token-authentication">webhook token authentication</a>, <a href="https://kubernetes.io/docs/reference/access-authn-authz/authentication/#service-account-tokens">service account tokens</a>, and as of February 21, 2021, OIDC authentication.  </p>
<p>The webhook authentication strategy calls a webhook that verifies bearer tokens. On EKS, these bearer tokens are generated by the AWS CLI or the <a href="https://github.com/kubernetes-sigs/aws-iam-authenticator">aws-iam-authenticator</a> client when you run <code>kubectl</code> commands. As you execute commands, the token is passed to the kube-apiserver which forwards it to the authentication webhook.  If the request is well-formed, the webhook calls a pre-signed URL embedded in the token's body. This URL validates the request's signature and returns information about the user, e.g. the user's account, Arn, and UserId to the kube-apiserver.  </p>
<p>To manually generate a authentication token, type the following command in a terminal window: </p>
<div class="codehilite"><pre><span></span><code>aws eks get-token --cluster &lt;cluster_name&gt;
</code></pre></div>

<p>You can also get a token programmatically. Below is an example written in Go: </p>
<div class="codehilite"><pre><span></span><code><span class="kn">package</span><span class="w"> </span><span class="nx">main</span><span class="w"></span>

<span class="kn">import</span><span class="w"> </span><span class="p">(</span><span class="w"></span>
<span class="w">    </span><span class="s">&quot;fmt&quot;</span><span class="w"></span>
<span class="w">    </span><span class="s">&quot;log&quot;</span><span class="w"></span>
<span class="w">    </span><span class="s">&quot;sigs.k8s.io/aws-iam-authenticator/pkg/token&quot;</span><span class="w"></span>
<span class="p">)</span><span class="w"></span>

<span class="kd">func</span><span class="w"> </span><span class="nx">main</span><span class="p">()</span><span class="w">  </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="nx">g</span><span class="p">,</span><span class="w"> </span><span class="nx">_</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">token</span><span class="p">.</span><span class="nx">NewGenerator</span><span class="p">(</span><span class="kc">false</span><span class="p">,</span><span class="w"> </span><span class="kc">false</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="nx">tk</span><span class="p">,</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">g</span><span class="p">.</span><span class="nx">Get</span><span class="p">(</span><span class="s">&quot;&lt;cluster_name&gt;&quot;</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">nil</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="nx">log</span><span class="p">.</span><span class="nx">Fatal</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="nx">fmt</span><span class="p">.</span><span class="nx">Println</span><span class="p">(</span><span class="nx">tk</span><span class="p">)</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>

<p>The output should resemble this: </p>
<div class="codehilite"><pre><span></span><code><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="nt">&quot;kind&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;ExecCredential&quot;</span><span class="p">,</span><span class="w"> </span>
<span class="w">  </span><span class="nt">&quot;apiVersion&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;client.authentication.k8s.io/v1alpha1&quot;</span><span class="p">,</span><span class="w"> </span>
<span class="w">  </span><span class="nt">&quot;spec&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{},</span><span class="w"> </span>
<span class="w">  </span><span class="nt">&quot;status&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="nt">&quot;expirationTimestamp&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;2020-02-19T16:08:27Z&quot;</span><span class="p">,</span><span class="w"> </span>
<span class="w">    </span><span class="nt">&quot;token&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;k8s-aws-v1.aHR0cHM6Ly9zdHMuYW1hem9uYXdzLmNvbS8_QWN0aW9uPUdldENhbGxlcklkZW50aXR5JlZlcnNpb249MjAxMS0wNi0xNSZYLUFtei1BbGdvcml0aG09QVdTNC1ITUFDLVNIQTI1NiZYLUFtei1DcmVkZW50aWFsPUFLSUFKTkdSSUxLTlNSQzJXNVFBJTJGMjAyMDAyMTklMkZ1cy1lYXN0LTElMkZzdHMlMkZhd3M0X3JlcXVlc3QmWC1BbXotRGF0ZT0yMDIwMDIxOVQxNTU0MjdaJlgtQW16LUV4cGlyZXM9NjAmWC1BbXotU2lnbmVkSGVhZGVycz1ob3N0JTNCeC1rOHMtYXdzLWlkJlgtQW16LVNpZ25hdHVyZT0yMjBmOGYzNTg1ZTMyMGRkYjVlNjgzYTVjOWE0MDUzMDFhZDc2NTQ2ZjI0ZjI4MTExZmRhZDA5Y2Y2NDhhMzkz&quot;</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>

<p>Each token starts with <code>k8s-aws-v1.</code> followed by a base64 encoded string. The string, when decoded, should resemble this: </p>
<div class="codehilite"><pre><span></span><code>https://sts.amazonaws.com/?Action<span class="o">=</span>GetCallerIdentity<span class="p">&amp;</span><span class="nv">Version</span><span class="o">=</span><span class="m">2011</span>-06-15<span class="p">&amp;</span>X-Amz-Algorithm<span class="o">=</span>AWS4-HMAC-SHA256<span class="p">&amp;</span>X-Amz-Credential<span class="o">=</span>AKIAJPFRILKNSRC2W5QA%2F20200219%2Fus-east-1%2Fsts%2Faws4_request<span class="p">&amp;</span>X-Amz-Date<span class="o">=</span>20200219T155427Z<span class="p">&amp;</span>X-Amz-Expires<span class="o">=</span><span class="m">60</span><span class="p">&amp;</span>X-Amz-SignedHeaders<span class="o">=</span>host%3Bx-k8s-aws-id<span class="p">&amp;</span>X-Amz-Signature<span class="o">=</span>220f8f3285e320ddb5e683a5c9a405301ad76546f24f28111fdad09cf648a393
</code></pre></div>

<p>The token consists of a pre-signed URL that includes an Amazon credential and signature. For additional details see <a href="https://docs.aws.amazon.com/STS/latest/APIReference/API_GetCallerIdentity.html">https://docs.aws.amazon.com/STS/latest/APIReference/API_GetCallerIdentity.html</a>. </p>
<p>The token has a time to live (TTL) of 15 minutes after which a new token will need to be generated. This is handled automatically when you use a client like <code>kubectl</code>, however, if you're using the Kubernetes dashboard, you will need to generate a new token and re-authenticate each time the token expires. </p>
<p>Once the user's identity has been authenticated by the AWS IAM service, the kube-apiserver reads the <code>aws-auth</code> ConfigMap in the <code>kube-system</code> Namespace to determine the RBAC group to associate with the user.  The <code>aws-auth</code> ConfigMap is used to create a static mapping between IAM principals, i.e. IAM Users and Roles, and Kubernetes RBAC groups. RBAC groups can be referenced in Kubernetes RoleBindings or ClusterRoleBindings. They are similar to IAM Roles in that they define a set of actions (verbs) that can be performed against a collection of Kubernetes resources (objects).</p>
<h2 id="recommendations">Recommendations<a class="headerlink" href="#recommendations" title="Permanent link">&para;</a></h2>
<h3 id="dont-use-a-service-account-token-for-authentication">Don't use a service account token for authentication<a class="headerlink" href="#dont-use-a-service-account-token-for-authentication" title="Permanent link">&para;</a></h3>
<p>A service account token is a long-lived, static credential. If it is compromised, lost, or stolen, an attacker may be able to perform all the actions associated with that token until the service account is deleted. At times, you may need to grant an exception for applications that have to consume the Kubernetes API from outside the cluster, e.g. a CI/CD pipeline application. If such applications run on AWS infrastructure, like EC2 instances, consider using an instance profile and mapping that to a Kubernetes RBAC role in the <code>aws-auth</code> ConfigMap instead.</p>
<h3 id="employ-least-privileged-access-to-aws-resources">Employ least privileged access to AWS Resources<a class="headerlink" href="#employ-least-privileged-access-to-aws-resources" title="Permanent link">&para;</a></h3>
<p>An IAM User does not need to be assigned privileges to AWS resources to access the Kubernetes API. If you need to grant an IAM user access to an EKS cluster, create an entry in the <code>aws-auth</code> ConfigMap for that user that maps to a specific Kubernetes RBAC group. </p>
<h3 id="use-iam-roles-when-multiple-users-need-identical-access-to-the-cluster">Use IAM Roles when multiple users need identical access to the cluster<a class="headerlink" href="#use-iam-roles-when-multiple-users-need-identical-access-to-the-cluster" title="Permanent link">&para;</a></h3>
<p>Rather than creating an entry for each individual IAM User in the <code>aws-auth</code> ConfigMap, allow those users to assume an IAM Role and map that role to a Kubernetes RBAC group.  This will be easier to maintain, especially as the number of users that require access grows.</p>
<div class="admonition attention">
<p class="admonition-title">Attention</p>
<p>When accessing the EKS cluster with the IAM entity mapped by aws-auth ConfigMap, the username described in aws-auth ConfigMap is recorded in the user field of the Kubernetes audit log. If you're using an IAM role, the actual users who assume that role aren't recorded and can't be audited.</p>
</div>
<p>When assigning K8s RBAC permissions to an IAM role using mapRoles in aws-auth ConfigMap, you should include {{SessionName}} in your username. That way, the audit log will record the session name so you can track who the actual user assume this role along with the CloudTrail log.</p>
<div class="codehilite"><pre><span></span><code><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">rolearn</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">arn:aws:iam::XXXXXXXXXXXX:role/testRole</span><span class="w"></span>
<span class="w">  </span><span class="nt">username</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">testRole:{{SessionName}}</span><span class="w"></span>
<span class="w">  </span><span class="nt">groups</span><span class="p">:</span><span class="w"></span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">system:masters</span><span class="w"></span>
</code></pre></div>

<p>In Kubernetes 1.20 and above, this change is no longer required, since <code>user.extra.sessionName.0</code> was added to the Kubernetes audit log.</p>
<h3 id="employ-least-privileged-access-when-creating-rolebindings-and-clusterrolebindings">Employ least privileged access when creating RoleBindings and ClusterRoleBindings<a class="headerlink" href="#employ-least-privileged-access-when-creating-rolebindings-and-clusterrolebindings" title="Permanent link">&para;</a></h3>
<p>Like the earlier point about granting access to AWS Resources, RoleBindings and ClusterRoleBindings should only include the set of permissions necessary to perform a specific function. Avoid using <code>["*"]</code> in your Roles and ClusterRoles unless it's absolutely necessary. If you're unsure what permissions to assign, consider using a tool like <a href="https://github.com/liggitt/audit2rbac">audit2rbac</a> to automatically generate Roles and binding based on the observed API calls in the Kubernetes Audit Log.</p>
<h3 id="make-the-eks-cluster-endpoint-private">Make the EKS Cluster Endpoint private<a class="headerlink" href="#make-the-eks-cluster-endpoint-private" title="Permanent link">&para;</a></h3>
<p>By default when you provision an EKS cluster, the API cluster endpoint is set to public, i.e. it can be accessed from the Internet. Despite being accessible from the Internet, the endpoint is still considered secure because it requires all API requests to be authenticated by IAM and then authorized by Kubernetes RBAC. That said, if your corporate security policy mandates that you restrict access to the API from the Internet or prevents you from routing traffic outside the cluster VPC, you can: </p>
<ul>
<li>Configure the EKS cluster endpoint to be private. See <a href="https://docs.aws.amazon.com/eks/latest/userguide/cluster-endpoint.html">Modifying Cluster Endpoint Access</a> for further information on this topic. </li>
<li>Leave the cluster endpoint public and specify which CIDR blocks can communicate with the cluster endpoint. The blocks are effectively a whitelisted set of public IP addresses that are allowed to access the cluster endpoint.</li>
<li>Configure public access with a set of whitelisted CIDR blocks and set private endpoint access to enabled. This will allow public access from a specific range of public IPs while forcing all network traffic between the kubelets (workers) and the Kubernetes API through the cross-account ENIs that get provisioned into the cluster VPC when the control plane is provisioned.</li>
</ul>
<h3 id="create-the-cluster-with-a-dedicated-iam-role">Create the cluster with a dedicated IAM role<a class="headerlink" href="#create-the-cluster-with-a-dedicated-iam-role" title="Permanent link">&para;</a></h3>
<p>When you create an Amazon EKS cluster, the IAM entity user or role, such as a federated user that creates the cluster, is automatically granted <code>system:masters</code> permissions in the cluster's RBAC configuration. This access cannot be removed and is not managed through the <code>aws-auth</code> ConfigMap. Therefore it is a good idea to create the cluster with a dedicated IAM role and regularly audit who can assume this role. This role should not be used to perform routine actions on the cluster, and instead additional users should be granted access to the cluster through the <code>aws-auth</code> ConfigMap for this purpose. After the <code>aws-auth</code> ConfigMap is configured, the role can be deleted and only recreated in an emergency / break glass scenario where the <code>aws-auth</code> ConfigMap is corrupted and the cluster is otherwise inaccessible. This can be particularly useful in production clusters which do not usually have direct user access configured.</p>
<h3 id="use-tools-to-make-changes-to-the-aws-auth-configmap">Use tools to make changes to the aws-auth ConfigMap<a class="headerlink" href="#use-tools-to-make-changes-to-the-aws-auth-configmap" title="Permanent link">&para;</a></h3>
<p>An improperly formatted aws-auth ConfigMap may cause you to lose access to the cluster. If you need to make changes to the ConfigMap, use a tool.</p>
<p><strong>eksctl</strong></p>
<p>The <code>eksctl</code> CLI includes a command for adding identity mappings to the aws-auth
ConfigMap.</p>
<p>View CLI Help:</p>
<div class="codehilite"><pre><span></span><code>eksctl create iamidentitymapping --help
</code></pre></div>

<p>Make an IAM Role a Cluster Admin:</p>
<div class="codehilite"><pre><span></span><code><span class="w"> </span><span class="n">eksctl</span><span class="w"> </span><span class="n">create</span><span class="w"> </span><span class="n">iamidentitymapping</span><span class="w"> </span><span class="o">--</span><span class="n">cluster</span><span class="w">  </span><span class="o">&lt;</span><span class="n">clusterName</span><span class="o">&gt;</span><span class="w"> </span><span class="o">--</span><span class="n">region</span><span class="o">=&lt;</span><span class="n">region</span><span class="o">&gt;</span><span class="w"> </span><span class="o">--</span><span class="n">arn</span><span class="w"> </span><span class="nl">arn:aws:</span><span class="n">iam</span><span class="o">::</span><span class="mh">123456</span><span class="o">:</span><span class="n">role</span><span class="o">/</span><span class="n">testing</span><span class="w"> </span><span class="o">--</span><span class="n">group</span><span class="w"> </span><span class="nl">system:</span><span class="n">masters</span><span class="w"> </span><span class="o">--</span><span class="n">username</span><span class="w"> </span><span class="n">admin</span><span class="w"></span>
</code></pre></div>

<p>For more information, review <a href="https://eksctl.io/usage/iam-identity-mappings/"><code>eksctl</code> docs</a></p>
<p><strong><a href="https://github.com/keikoproj/aws-auth">aws-auth</a> by keikoproj</strong></p>
<p><code>aws-auth</code> by keikoproj includes both a cli and a go library.</p>
<p>Download and view help CLI help:</p>
<div class="codehilite"><pre><span></span><code><span class="k">go</span><span class="w"> </span><span class="k">get</span><span class="w"> </span><span class="n">github</span><span class="p">.</span><span class="n">com</span><span class="o">/</span><span class="n">keikoproj</span><span class="o">/</span><span class="n">aws</span><span class="o">-</span><span class="n">auth</span><span class="w"></span>
<span class="n">aws</span><span class="o">-</span><span class="n">auth</span><span class="w"> </span><span class="n">help</span><span class="w"></span>
</code></pre></div>

<p>Alternatively, install <code>aws-auth</code> with the <a href="https://krew.sigs.k8s.io">krew plugin manager</a> for kubectl.</p>
<div class="codehilite"><pre><span></span><code>kubectl krew install aws-auth
kubectl aws-auth
</code></pre></div>

<p><a href="https://github.com/keikoproj/aws-auth/blob/master/README.md">Review the aws-auth docs on GitHub</a> for more information, including the go library.</p>
<p><strong><a href="https://github.com/kubernetes-sigs/aws-iam-authenticator/tree/master/cmd/aws-iam-authenticator">AWS IAM Authenticator CLI</a></strong></p>
<p>The <code>aws-iam-authenticator</code> project includes a CLI for updating the ConfigMap.</p>
<p><a href="https://github.com/kubernetes-sigs/aws-iam-authenticator/releases">Download a release</a> on GitHub.</p>
<p>Add cluster permissions to an IAM Role:</p>
<div class="codehilite"><pre><span></span><code>./aws-iam-authenticator add role --rolearn arn:aws:iam::185309785115:role/lil-dev-role-cluster --username lil-dev-user --groups system:masters --kubeconfig ~/.kube/config
</code></pre></div>

<h3 id="regularly-audit-access-to-the-cluster">Regularly audit access to the cluster<a class="headerlink" href="#regularly-audit-access-to-the-cluster" title="Permanent link">&para;</a></h3>
<p>Who requires access is likely to change over time. Plan to periodically audit the <code>aws-auth</code> ConfigMap to see who has been granted access and the rights they've been assigned. You can also use open source tooling like <a href="https://github.com/aquasecurity/kubectl-who-can">kubectl-who-can</a>, or <a href="https://github.com/FairwindsOps/rbac-lookup">rbac-lookup</a> to examine the roles bound to a particular service account, user, or group. We'll explore this topic further when we get to the section on <a href="../detective/">auditing</a>.  Additional ideas can be found in this <a href="https://www.nccgroup.trust/us/about-us/newsroom-and-events/blog/2019/august/tools-and-methods-for-auditing-kubernetes-rbac-policies/?mkt_tok=eyJpIjoiWWpGa056SXlNV1E0WWpRNSIsInQiOiJBT1hyUTRHYkg1TGxBV0hTZnRibDAyRUZ0VzBxbndnRzNGbTAxZzI0WmFHckJJbWlKdE5WWDdUQlBrYVZpMnNuTFJ1R3hacVYrRCsxYWQ2RTRcL2pMN1BtRVA1ZFZcL0NtaEtIUDdZV3pENzNLcE1zWGVwUndEXC9Pb2tmSERcL1pUaGUifQ%3D%3D">article</a> from NCC Group. </p>
<h3 id="alternative-approaches-to-authentication-and-access-management">Alternative Approaches to Authentication and Access Management<a class="headerlink" href="#alternative-approaches-to-authentication-and-access-management" title="Permanent link">&para;</a></h3>
<p>While IAM is the preferred way to authenticate users who need access to an EKS cluster, it is possible to use an OIDC identity provider such as GitHub using an authentication proxy and Kubernetes <a href="https://kubernetes.io/docs/reference/access-authn-authz/authentication/#user-impersonation">impersonation</a>. Posts for two such solutions have been published on the AWS Open Source blog:</p>
<ul>
<li><a href="https://aws.amazon.com/blogs/opensource/authenticating-eks-github-credentials-teleport/">Authenticating to EKS Using GitHub Credentials with Teleport</a></li>
<li><a href="https://aws.amazon.com/blogs/opensource/consistent-oidc-authentication-across-multiple-eks-clusters-using-kube-oidc-proxy/">Consistent OIDC authentication across multiple EKS clusters using kube-oidc-proxy</a></li>
</ul>
<div class="admonition attention">
<p class="admonition-title">Attention</p>
<p>EKS natively supports OIDC authentication without using a proxy. For further information, please read the launch blog, <a href="https://aws.amazon.com/blogs/containers/introducing-oidc-identity-provider-authentication-amazon-eks/">Introducing OIDC identity provider authentication for Amazon EKS</a>. For an example showing how to configure EKS with Dex, a popular open source OIDC provider with connectors for a variety of different authention methods, see <a href="https://aws.amazon.com/blogs/containers/using-dex-dex-k8s-authenticator-to-authenticate-to-amazon-eks/">Using Dex &amp; dex-k8s-authenticator to authenticate to Amazon EKS</a>. As described in the blogs, the username/group of users authenticated by an OIDC provider will appear in the Kubernetes audit log. </p>
</div>
<p>You can also use <a href="https://docs.aws.amazon.com/singlesignon/latest/userguide/what-is.html">AWS SSO</a> to federate AWS with an external identity provider, e.g. Azure AD. If you decide to use this, the AWS CLI v2.0 includes an option to create a named profile that makes it easy to associate an SSO session with your current CLI session and assume an IAM role. Know that you must assume a role <em>prior</em> to running <code>kubectl</code> as the IAM role is used to determine the user's Kubernetes RBAC group.</p>
<h3 id="additional-resources">Additional Resources<a class="headerlink" href="#additional-resources" title="Permanent link">&para;</a></h3>
<p><a href="https://github.com/mhausenblas/rbac.dev">rbac.dev</a> A list of additional resources, including blogs and tools, for Kubernetes RBAC</p>
<h2 id="pods-identities">Pods Identities<a class="headerlink" href="#pods-identities" title="Permanent link">&para;</a></h2>
<p>Certain applications that run within a Kubernetes cluster need permission to call the Kubernetes API to function properly. For example, the <a href="https://github.com/kubernetes-sigs/aws-load-balancer-controller">AWS Load Balancer Controller</a> needs to be able to list a Service's Endpoints. The controller also needs to be able to invoke AWS APIs to provision and configure an ALB.  In this section we will explore the best practices for assigning rights and privileges to Pods. </p>
<h3 id="kubernetes-service-accounts">Kubernetes Service Accounts<a class="headerlink" href="#kubernetes-service-accounts" title="Permanent link">&para;</a></h3>
<p>A service account is a special type of object that allows you to assign a Kubernetes RBAC role to a pod.  A default service account is created automatically for each Namespace within a cluster. When you deploy a pod into a Namespace without referencing a specific service account, the default service account for that Namespace will automatically get assigned to the Pod and the Secret, i.e. the service account (JWT) token for that service account, will get mounted to the pod as a volume at <code>/var/run/secrets/kubernetes.io/serviceaccount</code>. Decoding the service account token in that directory will reveal the following metadata: </p>
<div class="codehilite"><pre><span></span><code><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="nt">&quot;iss&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;kubernetes/serviceaccount&quot;</span><span class="p">,</span><span class="w"></span>
<span class="w">  </span><span class="nt">&quot;kubernetes.io/serviceaccount/namespace&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;default&quot;</span><span class="p">,</span><span class="w"></span>
<span class="w">  </span><span class="nt">&quot;kubernetes.io/serviceaccount/secret.name&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;default-token-5pv4z&quot;</span><span class="p">,</span><span class="w"></span>
<span class="w">  </span><span class="nt">&quot;kubernetes.io/serviceaccount/service-account.name&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;default&quot;</span><span class="p">,</span><span class="w"></span>
<span class="w">  </span><span class="nt">&quot;kubernetes.io/serviceaccount/service-account.uid&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;3b36ddb5-438c-11ea-9438-063a49b60fba&quot;</span><span class="p">,</span><span class="w"></span>
<span class="w">  </span><span class="nt">&quot;sub&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;system:serviceaccount:default:default&quot;</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>

<p>The default service account has the following permissions to the Kubernetes API.</p>
<div class="codehilite"><pre><span></span><code><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">rbac.authorization.k8s.io/v1</span><span class="w"></span>
<span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">ClusterRole</span><span class="w"></span>
<span class="nt">metadata</span><span class="p">:</span><span class="w"></span>
<span class="w">  </span><span class="nt">annotations</span><span class="p">:</span><span class="w"></span>
<span class="w">    </span><span class="nt">rbac.authorization.kubernetes.io/autoupdate</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;true&quot;</span><span class="w"></span>
<span class="w">  </span><span class="nt">creationTimestamp</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;2020-01-30T18:13:25Z&quot;</span><span class="w"></span>
<span class="w">  </span><span class="nt">labels</span><span class="p">:</span><span class="w"></span>
<span class="w">    </span><span class="nt">kubernetes.io/bootstrapping</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">rbac-defaults</span><span class="w"></span>
<span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">system:discovery</span><span class="w"></span>
<span class="w">  </span><span class="nt">resourceVersion</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;43&quot;</span><span class="w"></span>
<span class="w">  </span><span class="nt">selfLink</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">/apis/rbac.authorization.k8s.io/v1/clusterroles/system%3Adiscovery</span><span class="w"></span>
<span class="w">  </span><span class="nt">uid</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">350d2ab8-438c-11ea-9438-063a49b60fba</span><span class="w"></span>
<span class="nt">rules</span><span class="p">:</span><span class="w"></span>
<span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">nonResourceURLs</span><span class="p">:</span><span class="w"></span>
<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">/api</span><span class="w"></span>
<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">/api/*</span><span class="w"></span>
<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">/apis</span><span class="w"></span>
<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">/apis/*</span><span class="w"></span>
<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">/healthz</span><span class="w"></span>
<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">/openapi</span><span class="w"></span>
<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">/openapi/*</span><span class="w"></span>
<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">/version</span><span class="w"></span>
<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">/version/</span><span class="w"></span>
<span class="w">  </span><span class="nt">verbs</span><span class="p">:</span><span class="w"></span>
<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">get</span><span class="w"></span>
</code></pre></div>

<p>This role authorizes unauthenticated and authenticated users to read API information and is deemed safe to be publicly accessible.</p>
<p>When an application running within a Pod calls the Kubernetes APIs, the Pod needs to be assigned a service account that explicitly grants it permission to call those APIs.  Similar to guidelines for user access, the Role or ClusterRole bound to a service account should be restricted to the API resources and methods that the application needs to function and nothing else. To use a non-default service account simply set the <code>spec.serviceAccountName</code> field of a Pod to the name of the service account you wish to use. For additional information about creating service accounts, see <a href="https://kubernetes.io/docs/reference/access-authn-authz/rbac/#service-account-permissions">https://kubernetes.io/docs/reference/access-authn-authz/rbac/#service-account-permissions</a>. </p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Prior to Kubernetes 1.24, Kubernetes would automatically create a secret for each a service account. This secret was mounted to the pod at /var/run/secrets/kubernetes.io/serviceaccount and would be used by the pod to authenticate to the Kubernetes API server. In Kubernetes 1.24, a service account token is dynamically generated when the pod runs and is only valid for an hour by default. A secret for the service account will not be created. If you have an application that runs outside the cluster that needs to authenticate to the Kubernetes API, e.g. Jenkins, you will need to create a secret of type <code>kubernetes.io/service-account-token</code> along with an annotation that references the service account such as <code>metadata.annotations.kubernetes.io/service-account.name: &lt;SERVICE_ACCOUNT_NAME&gt;</code>. Secrets created in this way do not expire.</p>
</div>
<h3 id="iam-roles-for-service-accounts-irsa">IAM Roles for Service Accounts (IRSA)<a class="headerlink" href="#iam-roles-for-service-accounts-irsa" title="Permanent link">&para;</a></h3>
<p>IRSA is a feature that allows you to assign an IAM role to a Kubernetes service account. It works by leveraging a Kubernetes feature known as <a href="https://kubernetes.io/docs/tasks/configure-pod-container/configure-service-account/#service-account-token-volume-projection">Service Account Token Volume Projection</a>. When Pods are configured with a Service Account that references an IAM Role, the Kubernetes API server will call the public OIDC discovery endpoint for the cluster on startup. The endpoint cryptographically signs the OIDC token issued by Kubernetes and the resulting token mounted as a volume. This signed token allows the Pod to call the AWS APIs associated IAM role. When an AWS API is invoked, the AWS SDKs calls <code>sts:AssumeRoleWithWebIdentity</code>. After validating the token's signature, IAM exchanges the Kubernetes issued token for a temporary AWS role credential. </p>
<p>Decoding the (JWT) token for IRSA will produce output similar to the example you see below: </p>
<div class="codehilite"><pre><span></span><code><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="nt">&quot;aud&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w"></span>
<span class="w">    </span><span class="s2">&quot;sts.amazonaws.com&quot;</span><span class="w"></span>
<span class="w">  </span><span class="p">],</span><span class="w"></span>
<span class="w">  </span><span class="nt">&quot;exp&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">1582306514</span><span class="p">,</span><span class="w"></span>
<span class="w">  </span><span class="nt">&quot;iat&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">1582220114</span><span class="p">,</span><span class="w"></span>
<span class="w">  </span><span class="nt">&quot;iss&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;https://oidc.eks.us-west-2.amazonaws.com/id/D43CF17C27A865933144EA99A26FB128&quot;</span><span class="p">,</span><span class="w"></span>
<span class="w">  </span><span class="nt">&quot;kubernetes.io&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="nt">&quot;namespace&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;default&quot;</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="nt">&quot;pod&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="nt">&quot;name&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;alpine-57b5664646-rf966&quot;</span><span class="p">,</span><span class="w"></span>
<span class="w">      </span><span class="nt">&quot;uid&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;5a20f883-5407-11ea-a85c-0e62b7a4a436&quot;</span><span class="w"></span>
<span class="w">    </span><span class="p">},</span><span class="w"></span>
<span class="w">    </span><span class="nt">&quot;serviceaccount&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="nt">&quot;name&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;s3-read-only&quot;</span><span class="p">,</span><span class="w"></span>
<span class="w">      </span><span class="nt">&quot;uid&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;a720ba5c-5406-11ea-9438-063a49b60fba&quot;</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="w">  </span><span class="p">},</span><span class="w"></span>
<span class="w">  </span><span class="nt">&quot;nbf&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">1582220114</span><span class="p">,</span><span class="w"></span>
<span class="w">  </span><span class="nt">&quot;sub&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;system:serviceaccount:default:s3-read-only&quot;</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>

<p>This particular token grants the Pod view-only privileges to S3. When the application attempts to read from S3, the token is exchanged for a temporary set of IAM credentials that resembles this: </p>
<div class="codehilite"><pre><span></span><code><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="nt">&quot;AssumedRoleUser&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="nt">&quot;AssumedRoleId&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;AROA36C6WWEJULFUYMPB6:abc&quot;</span><span class="p">,</span><span class="w"> </span>
<span class="w">        </span><span class="nt">&quot;Arn&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;arn:aws:sts::123456789012:assumed-role/eksctl-winterfell-addon-iamserviceaccount-de-Role1-1D61LT75JH3MB/abc&quot;</span><span class="w"></span>
<span class="w">    </span><span class="p">},</span><span class="w"> </span>
<span class="w">    </span><span class="nt">&quot;Audience&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;sts.amazonaws.com&quot;</span><span class="p">,</span><span class="w"> </span>
<span class="w">    </span><span class="nt">&quot;Provider&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;arn:aws:iam::123456789012:oidc-provider/oidc.eks.us-west-2.amazonaws.com/id/D43CF17C27A865933144EA99A26FB128&quot;</span><span class="p">,</span><span class="w"> </span>
<span class="w">    </span><span class="nt">&quot;SubjectFromWebIdentityToken&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;system:serviceaccount:default:s3-read-only&quot;</span><span class="p">,</span><span class="w"> </span>
<span class="w">    </span><span class="nt">&quot;Credentials&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="nt">&quot;SecretAccessKey&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;ORJ+8Adk+wW+nU8FETq7+mOqeA8Z6jlPihnV8hX1&quot;</span><span class="p">,</span><span class="w"> </span>
<span class="w">        </span><span class="nt">&quot;SessionToken&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;FwoGZXIvYXdzEGMaDMLxAZkuLpmSwYXShiL9A1S0X87VBC1mHCrRe/pB2oes+l1eXxUYnPJyC9ayOoXMvqXQsomq0xs6OqZ3vaa5Iw1HIyA4Cv1suLaOCoU3hNvOIJ6C94H1vU0siQYk7DIq9Av5RZe+uE2FnOctNBvYLd3i0IZo1ajjc00yRK3v24VRq9nQpoPLuqyH2jzlhCEjXuPScPbi5KEVs9fNcOTtgzbVf7IG2gNiwNs5aCpN4Bv/Zv2A6zp5xGz9cWj2f0aD9v66vX4bexOs5t/YYhwuwAvkkJPSIGvxja0xRThnceHyFHKtj0H+bi/PWAtlI8YJcDX69cM30JAHDdQH+ltm/4scFptW1hlvMaP+WReCAaCrsHrAT+yka7ttw5YlUyvZ8EPog+j6fwHlxmrXM9h1BqdikomyJU00gm1++FJelfP+1zAwcyrxCnbRl3ARFrAt8hIlrT6Vyu8WvWtLxcI8KcLcJQb/LgkW+sCTGlYcY8z3zkigJMbYn07ewTL5Ss7LazTJJa758I7PZan/v3xQHd5DEc5WBneiV3iOznDFgup0VAMkIviVjVCkszaPSVEdK2NU7jtrh6Jfm7bU/3P6ZG+CkyDLIa8MBn9KPXeJd/y+jTk5Ii+fIwO/+mDpGNUribg6TPxhzZ8b/XdZO1kS1gVgqjXyVC+M+BRBh6C4H21w/eMzjCtDIpoxt5rGKL6Nu/IFMipoC4fgx6LIIHwtGYMG7SWQi7OsMAkiwZRg0n68/RqWgLzBt/4pfjSRYuk=&quot;</span><span class="p">,</span><span class="w"> </span>
<span class="w">        </span><span class="nt">&quot;Expiration&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;2020-02-20T18:49:50Z&quot;</span><span class="p">,</span><span class="w"> </span>
<span class="w">        </span><span class="nt">&quot;AccessKeyId&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;ASIA36C6WWEJUMHA3L7Z&quot;</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>

<p>A mutating webhook that runs as part of the EKS control plane injects the AWS Role ARN and the path to a web identity token file into the Pod as environment variables. These values can also be supplied manually. </p>
<div class="codehilite"><pre><span></span><code><span class="n">AWS_ROLE_ARN</span><span class="o">=</span><span class="n">arn</span><span class="p">:</span><span class="n">aws</span><span class="p">:</span><span class="n">iam</span><span class="p">::</span><span class="n">AWS_ACCOUNT_ID</span><span class="p">:</span><span class="n">role</span><span class="o">/</span><span class="n">IAM_ROLE_NAME</span><span class="w"></span>
<span class="n">AWS_WEB_IDENTITY_TOKEN_FILE</span><span class="o">=/</span><span class="k">var</span><span class="o">/</span><span class="n">run</span><span class="o">/</span><span class="n">secrets</span><span class="o">/</span><span class="n">eks</span><span class="o">.</span><span class="n">amazonaws</span><span class="o">.</span><span class="n">com</span><span class="o">/</span><span class="n">serviceaccount</span><span class="o">/</span><span class="n">token</span><span class="w"></span>
</code></pre></div>

<p>The kubelet will automatically rotate the projected token when it is older than 80% of its total TTL, or after 24 hours. The AWS SDKs are responsible for reloading the token when it rotates. For further information about IRSA, see <a href="https://docs.aws.amazon.com/eks/latest/userguide/iam-roles-for-service-accounts-technical-overview.html">https://docs.aws.amazon.com/eks/latest/userguide/iam-roles-for-service-accounts-technical-overview.html</a>.</p>
<h2 id="recommendations_1">Recommendations<a class="headerlink" href="#recommendations_1" title="Permanent link">&para;</a></h2>
<h3 id="update-the-aws-node-daemonset-to-use-irsa">Update the aws-node daemonset to use IRSA<a class="headerlink" href="#update-the-aws-node-daemonset-to-use-irsa" title="Permanent link">&para;</a></h3>
<p>At present, the aws-node daemonset is configured to use a role assigned to the EC2 instances to assign IPs to pods.  This role includes several AWS managed policies, e.g. AmazonEKS_CNI_Policy and EC2ContainerRegistryReadOnly that effectively allow <strong>all</strong> pods running on a node to attach/detach ENIs, assign/unassign IP addresses, or pull images from ECR. Since this presents a risk to your cluster, it is recommended that you update the aws-node daemonset to use IRSA. A script for doing this can be found in the <a href="https://github.com/aws/aws-eks-best-practices/tree/master/projects/enable-irsa/src">repository</a> for this guide.</p>
<h3 id="restrict-access-to-the-instance-profile-assigned-to-the-worker-node">Restrict access to the instance profile assigned to the worker node<a class="headerlink" href="#restrict-access-to-the-instance-profile-assigned-to-the-worker-node" title="Permanent link">&para;</a></h3>
<p>When you use IRSA, it updates the credential chain of the pod to use the IRSA token, however, the pod <em>can still inherit the rights of the instance profile assigned to the worker node</em>. When using IRSA, it is <strong>strongly</strong> recommended that you block access <a href="https://docs.aws.amazon.com/AWSEC2/latest/UserGuide/configuring-instance-metadata-service.html">instance metadata</a> to minimize the blast radius of a breach. </p>
<div class="admonition caution">
<p class="admonition-title">Caution</p>
<p>Blocking access to instance metadata will prevent pods that do not use IRSA from inheriting the role assigned to the worker node. </p>
</div>
<p>You can block access to instance metadata by requiring the instance to use IMDSv2 only and updating the hop count to 1 as in the example below. You can also include these settings in the node group's launch template. Do <strong>not</strong> disable instance metadata as this will prevent components like the node termination handler and other things that rely on instance metadata from working properly.  </p>
<div class="codehilite"><pre><span></span><code>aws ec2 modify-instance-metadata-options --instance-id &lt;value&gt; --http-tokens required --http-put-response-hop-limit 1
</code></pre></div>

<p>You can also block a pod's access to EC2 metadata by manipulating iptables on the node. For further information about this method, see <a href="https://docs.aws.amazon.com/AWSEC2/latest/UserGuide/instancedata-data-retrieval.html#instance-metadata-limiting-access">Limiting access to the instance metadata service</a>.</p>
<p>If you have an application that is using an older version of the AWS SDK that doesn't support IRSA, and you want the pod to inherit the role assigned to the instance, consider using Kubernetes network policies to <strong>selectively</strong> allow access EC2 metadata.</p>
<p>Start with a policy that blocks access to the metadata service from all Pods:</p>
<div class="codehilite"><pre><span></span><code><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">networking.k8s.io/v1</span><span class="w"></span>
<span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">NetworkPolicy</span><span class="w"></span>
<span class="nt">metadata</span><span class="p">:</span><span class="w"></span>
<span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">deny-metadata-access</span><span class="w"></span>
<span class="w">  </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">example</span><span class="w"></span>
<span class="nt">spec</span><span class="p">:</span><span class="w"></span>
<span class="w">  </span><span class="nt">podSelector</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">{}</span><span class="w"></span>
<span class="w">  </span><span class="nt">policyTypes</span><span class="p">:</span><span class="w"></span>
<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Egress</span><span class="w"></span>
<span class="w">  </span><span class="nt">egress</span><span class="p">:</span><span class="w"></span>
<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">to</span><span class="p">:</span><span class="w"></span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">ipBlock</span><span class="p">:</span><span class="w"></span>
<span class="w">        </span><span class="nt">cidr</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">0.0.0.0/0</span><span class="w"></span>
<span class="w">        </span><span class="nt">except</span><span class="p">:</span><span class="w"></span>
<span class="w">        </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">169.254.169.254/32</span><span class="w"></span>
</code></pre></div>

<p>Then allow access from select pods by adding following policy, modifying the <code>PodSelector</code> as appropriate.</p>
<div class="codehilite"><pre><span></span><code><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">networking.k8s.io/v1</span><span class="w"></span>
<span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">NetworkPolicy</span><span class="w"></span>
<span class="nt">metadata</span><span class="p">:</span><span class="w"></span>
<span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">allow-metadata-access</span><span class="w"></span>
<span class="w">  </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">example</span><span class="w"></span>
<span class="nt">spec</span><span class="p">:</span><span class="w"></span>
<span class="w">  </span><span class="nt">podSelector</span><span class="p">:</span><span class="w"></span>
<span class="w">    </span><span class="nt">matchLabels</span><span class="p">:</span><span class="w"></span>
<span class="w">      </span><span class="nt">app</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">myapp</span><span class="w">  </span>
<span class="w">  </span><span class="nt">policyTypes</span><span class="p">:</span><span class="w"></span>
<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Egress</span><span class="w"></span>
<span class="w">  </span><span class="nt">egress</span><span class="p">:</span><span class="w"></span>
<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">to</span><span class="p">:</span><span class="w"></span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">ipBlock</span><span class="p">:</span><span class="w"></span>
<span class="w">        </span><span class="nt">cidr</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">169.254.169.254/32</span><span class="w"></span>
</code></pre></div>

<h3 id="scope-the-iam-role-trust-policy-for-irsa-to-the-service-account-name">Scope the IAM Role trust policy for IRSA to the service account name<a class="headerlink" href="#scope-the-iam-role-trust-policy-for-irsa-to-the-service-account-name" title="Permanent link">&para;</a></h3>
<p>The trust policy can be scoped to a Namespace or a specific service account within a Namespace. When using IRSA it's best to make the role trust policy as explicit as possible by including the service account name. This will effectively prevent other Pods within the same Namespace from assuming the role. The CLI <code>eksctl</code> will do this automatically when you use it to create service accounts/IAM roles. See <a href="https://eksctl.io/usage/iamserviceaccounts/">https://eksctl.io/usage/iamserviceaccounts/</a> for further information. </p>
<h3 id="when-your-application-needs-access-to-imds-use-imdsv2-and-increase-the-hop-limit-on-ec2-instances-to-2">When your application needs access to IMDS, use IMDSv2 and increase the hop limit on EC2 instances to 2<a class="headerlink" href="#when-your-application-needs-access-to-imds-use-imdsv2-and-increase-the-hop-limit-on-ec2-instances-to-2" title="Permanent link">&para;</a></h3>
<p><a href="https://docs.aws.amazon.com/AWSEC2/latest/UserGuide/configuring-instance-metadata-service.html">IMDSv2</a> requires you use a PUT request to get a session token.  The initial PUT request has to include a TTL for the session token.  Newer versions of the AWS SDKs will handle this and the renewal of said token automatically. It's also important to be aware that the default hop limit on EC2 instances is intentionally set to 1 to prevent IP forwarding. As a consequence, Pods that request a session token that are run on EC2 instances may eventually time out and fallback to using the IMDSv1 data flow. EKS adds support IMDSv2 by <em>enabling</em> both v1 and v2 and changing the hop limit to 2 on nodes provisioned by eksctl or with the official CloudFormation templates. </p>
<h3 id="disable-auto-mounting-of-service-account-tokens">Disable auto-mounting of service account tokens<a class="headerlink" href="#disable-auto-mounting-of-service-account-tokens" title="Permanent link">&para;</a></h3>
<p>If your application doesn't need to call the Kubernetes API set the <code>automountServiceAccountToken</code> attribute to <code>false</code> in the PodSpec for your application or patch the default service account in each namespace so that it's no longer mounted to pods automatically. For example: </p>
<div class="codehilite"><pre><span></span><code>kubectl patch serviceaccount default -p <span class="s1">$&#39;automountServiceAccountToken: false&#39;</span>
</code></pre></div>

<h3 id="use-dedicated-service-accounts-for-each-application">Use dedicated service accounts for each application<a class="headerlink" href="#use-dedicated-service-accounts-for-each-application" title="Permanent link">&para;</a></h3>
<p>Each application should have its own dedicated service account.  This applies to service accounts for the Kubernetes API as well as IRSA. </p>
<div class="admonition attention">
<p class="admonition-title">Attention</p>
<p>If you employ a blue/green approach to cluster upgrades instead of performing an in-place cluster upgrade, you will need to update the trust policy of each of the IRSA IAM roles with the OIDC endpoint of the new cluster. A blue/green cluster upgrade is where you create a cluster running a newer version of Kubernetes alongside the old cluster and use a load balancer or a service mesh to seamlessly shift traffic from services running on the old cluster to the new cluster. </p>
</div>
<h3 id="run-the-application-as-a-non-root-user">Run the application as a non-root user<a class="headerlink" href="#run-the-application-as-a-non-root-user" title="Permanent link">&para;</a></h3>
<p>Containers run as root by default. While this allows them to read the web identity token file, running a container as root is not considered a best practice. As an alternative, consider adding the <code>spec.securityContext.runAsUser</code> attribute to the PodSpec.  The value of <code>runAsUser</code> is arbitrary value.</p>
<p>In the following example, all processes within the Pod will run under the user ID specified in the <code>runAsUser</code> field. </p>
<div class="codehilite"><pre><span></span><code><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">v1</span><span class="w"></span>
<span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Pod</span><span class="w"></span>
<span class="nt">metadata</span><span class="p">:</span><span class="w"></span>
<span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">security-context-demo</span><span class="w"></span>
<span class="nt">spec</span><span class="p">:</span><span class="w"></span>
<span class="w">  </span><span class="nt">securityContext</span><span class="p">:</span><span class="w"></span>
<span class="w">    </span><span class="nt">runAsUser</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">1000</span><span class="w"></span>
<span class="w">    </span><span class="nt">runAsGroup</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">3000</span><span class="w"></span>
<span class="w">  </span><span class="nt">containers</span><span class="p">:</span><span class="w"></span>
<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">sec-ctx-demo</span><span class="w"></span>
<span class="w">    </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">busybox</span><span class="w"></span>
<span class="w">    </span><span class="nt">command</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[</span><span class="w"> </span><span class="s">&quot;sh&quot;</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="s">&quot;-c&quot;</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="s">&quot;sleep</span><span class="nv"> </span><span class="s">1h&quot;</span><span class="w"> </span><span class="p p-Indicator">]</span><span class="w"></span>
</code></pre></div>

<p>When you run a container as a non-root user, it prevents the container from reading the IRSA service account token because the token is assigned 0600 [root] permissions by default. If you update the securityContext for your container to include fsgroup=65534 [Nobody] it will allow the container to read the token.</p>
<div class="codehilite"><pre><span></span><code><span class="n">spec</span><span class="o">:</span><span class="w"></span>
<span class="w">  </span><span class="n">securityContext</span><span class="o">:</span><span class="w"></span>
<span class="w">    </span><span class="n">fsGroup</span><span class="o">:</span><span class="w"> </span><span class="mi">65534</span><span class="w"></span>
</code></pre></div>

<p>In Kubernetes 1.19 and above, this change is no longer required.</p>
<h3 id="grant-least-privileged-access-to-applications">Grant least privileged access to applications<a class="headerlink" href="#grant-least-privileged-access-to-applications" title="Permanent link">&para;</a></h3>
<p><a href="https://github.com/princespaghetti/actionhero">Action Hero</a> is a utility that you can run alongside your application to identify the AWS API calls and corresponding IAM permissions your application needs to function properly.  It is similar to <a href="https://docs.aws.amazon.com/IAM/latest/UserGuide/access_policies_access-advisor.html">IAM Access Advisor</a> in that it helps you gradually limit the scope of IAM roles assigned to applications. Consult the documentation on granting <a href="https://docs.aws.amazon.com/IAM/latest/UserGuide/best-practices.html#grant-least-privilege">least privileged access</a> to AWS resources for further information.</p>
<h3 id="review-and-revoke-unnecessary-anonymous-access">Review and revoke unnecessary anonymous access<a class="headerlink" href="#review-and-revoke-unnecessary-anonymous-access" title="Permanent link">&para;</a></h3>
<p>Ideally anonymous access should be disabled for all API actions. Anonymous access is granted by creating a RoleBinding or ClusterRoleBinding for the Kubernetes built-in user system:anonymous. You can use the <a href="https://github.com/FairwindsOps/rbac-lookup">rbac-lookup</a> tool to identify permissions that system:anonymous user has on your cluster:</p>
<div class="codehilite"><pre><span></span><code>./rbac-lookup | grep -P &#39;system:(anonymous)|(unauthenticated)&#39;
system:anonymous               cluster-wide        ClusterRole/system:discovery
system:unauthenticated         cluster-wide        ClusterRole/system:discovery
system:unauthenticated         cluster-wide        ClusterRole/system:public-info-viewer
</code></pre></div>

<p>Any role or ClusterRole other than system:public-info-viewer should not be bound to system:anonymous user or system:unauthenticated group.</p>
<p>There may be some legitimate reasons to enable anonymous access on specific APIs. If this is the case for your cluster ensure that only those specific APIs are accessible by anonymous user and exposing those APIs without authentication doesn’t make your cluster vulnerable. </p>
<p>Prior to Kubernetes/EKS Version 1.14, system:unauthenticated group was associated to system:discovery and system:basic-user ClusterRoles by default.  Note that even if you have updated your cluster to version 1.14 or higher, these permissions may still be enabled on your cluster, since cluster updates do not revoke these permissions. 
To check which ClusterRoles have "system:unauthenticated" except system:public-info-viewer you can run the following command (requires jq util):</p>
<div class="codehilite"><pre><span></span><code>kubectl get ClusterRoleBinding -o json | jq -r &#39;.items[] | select(.subjects[]?.name ==&quot;system:unauthenticated&quot;) | select(.metadata.name != &quot;system:public-info-viewer&quot;) | .metadata.name&#39;
</code></pre></div>

<p>And "system:unauthenticated" can be removed from all the roles except "system:public-info-viewer" using:</p>
<div class="codehilite"><pre><span></span><code>kubectl get ClusterRoleBinding -o json | jq -r &#39;.items[] | select(.subjects[]?.name ==&quot;system:unauthenticated&quot;) | select(.metadata.name != &quot;system:public-info-viewer&quot;) | del(.subjects[] | select(.name ==&quot;system:unauthenticated&quot;))&#39; | kubectl apply -f -
</code></pre></div>

<p>Alternatively, you can check and remove it manually by kubectl describe and kubectl edit. To check if system:unauthenticated group has system:discovery permissions on your cluster run the following command: </p>
<div class="codehilite"><pre><span></span><code>kubectl describe clusterrolebindings system:discovery

Name:         system:discovery
Labels:       kubernetes.io/bootstrapping=rbac-defaults
Annotations:  rbac.authorization.kubernetes.io/autoupdate: true
Role:
  Kind:  ClusterRole
  Name:  system:discovery
Subjects:
  Kind   Name                    Namespace
  ----   ----                    ---------
  Group  system:authenticated
  Group  system:unauthenticated
</code></pre></div>

<p>To check if system:unauthenticated group has system:basic-user permission on your cluster run the following command:</p>
<div class="codehilite"><pre><span></span><code>kubectl describe clusterrolebindings system:basic-user

Name:         system:basic-user
Labels:       kubernetes.io/bootstrapping=rbac-defaults
Annotations:  rbac.authorization.kubernetes.io/autoupdate: true
Role:
  Kind:  ClusterRole
  Name:  system:basic-user
Subjects:
  Kind   Name                    Namespace
  ----   ----                    ---------
  Group  system:authenticated
  Group  system:unauthenticated
</code></pre></div>

<p>If system:unauthenticated group is bound to system:discovery and/or system:basic-user ClusterRoles on your cluster, you should disassociate these roles from system:unauthenticated group. Edit system:discovery ClusterRoleBinding using the following command:</p>
<div class="codehilite"><pre><span></span><code>kubectl edit clusterrolebindings system:discovery
</code></pre></div>

<p>The above command will open the current definition of system:discovery ClusterRoleBinding in an editor as shown below:</p>
<div class="codehilite"><pre><span></span><code>#<span class="w"> </span><span class="nv">Please</span><span class="w"> </span><span class="nv">edit</span><span class="w"> </span><span class="nv">the</span><span class="w"> </span><span class="nv">object</span><span class="w"> </span><span class="nv">below</span>.<span class="w"> </span><span class="nv">Lines</span><span class="w"> </span><span class="nv">beginning</span><span class="w"> </span><span class="nv">with</span><span class="w"> </span><span class="nv">a</span><span class="w"> </span><span class="s1">&#39;#&#39;</span><span class="w"> </span><span class="nv">will</span><span class="w"> </span><span class="nv">be</span><span class="w"> </span><span class="nv">ignored</span>,<span class="w"></span>
#<span class="w"> </span><span class="nv">and</span><span class="w"> </span><span class="nv">an</span><span class="w"> </span><span class="nv">empty</span><span class="w"> </span><span class="nv">file</span><span class="w"> </span><span class="nv">will</span><span class="w"> </span><span class="nv">abort</span><span class="w"> </span><span class="nv">the</span><span class="w"> </span><span class="nv">edit</span>.<span class="w"> </span><span class="k">If</span><span class="w"> </span><span class="nv">an</span><span class="w"> </span><span class="nv">error</span><span class="w"> </span><span class="nv">occurs</span><span class="w"> </span><span class="k">while</span><span class="w"> </span><span class="nv">saving</span><span class="w"> </span><span class="nv">this</span><span class="w"> </span><span class="nv">file</span><span class="w"> </span><span class="nv">will</span><span class="w"> </span><span class="nv">be</span><span class="w"></span>
#<span class="w"> </span><span class="nv">reopened</span><span class="w"> </span><span class="nv">with</span><span class="w"> </span><span class="nv">the</span><span class="w"> </span><span class="nv">relevant</span><span class="w"> </span><span class="nv">failures</span>.<span class="w"></span>
#<span class="w"></span>
<span class="nv">apiVersion</span>:<span class="w"> </span><span class="nv">rbac</span>.<span class="nv">authorization</span>.<span class="nv">k8s</span>.<span class="nv">io</span><span class="o">/</span><span class="nv">v1</span><span class="w"></span>
<span class="nv">kind</span>:<span class="w"> </span><span class="nv">ClusterRoleBinding</span><span class="w"></span>
<span class="nv">metadata</span>:<span class="w"></span>
<span class="w">  </span><span class="nv">annotations</span>:<span class="w"></span>
<span class="w">    </span><span class="nv">rbac</span>.<span class="nv">authorization</span>.<span class="nv">kubernetes</span>.<span class="nv">io</span><span class="o">/</span><span class="nv">autoupdate</span>:<span class="w"> </span><span class="s2">&quot;true&quot;</span><span class="w"></span>
<span class="w">  </span><span class="nv">creationTimestamp</span>:<span class="w"> </span><span class="s2">&quot;2021-06-17T20:50:49Z&quot;</span><span class="w"></span>
<span class="w">  </span><span class="nv">labels</span>:<span class="w"></span>
<span class="w">    </span><span class="nv">kubernetes</span>.<span class="nv">io</span><span class="o">/</span><span class="nv">bootstrapping</span>:<span class="w"> </span><span class="nv">rbac</span><span class="o">-</span><span class="nv">defaults</span><span class="w"></span>
<span class="w">  </span><span class="nv">name</span>:<span class="w"> </span><span class="nv">system</span>:<span class="nv">discovery</span><span class="w"></span>
<span class="w">  </span><span class="nv">resourceVersion</span>:<span class="w"> </span><span class="s2">&quot;24502985&quot;</span><span class="w"></span>
<span class="w">  </span><span class="nv">selfLink</span>:<span class="w"> </span><span class="o">/</span><span class="nv">apis</span><span class="o">/</span><span class="nv">rbac</span>.<span class="nv">authorization</span>.<span class="nv">k8s</span>.<span class="nv">io</span><span class="o">/</span><span class="nv">v1</span><span class="o">/</span><span class="nv">clusterrolebindings</span><span class="o">/</span><span class="nv">system</span><span class="o">%</span><span class="mi">3</span><span class="nv">Adiscovery</span><span class="w"></span>
<span class="w">  </span><span class="nv">uid</span>:<span class="w"> </span><span class="nv">b7936268</span><span class="o">-</span><span class="mi">5043</span><span class="o">-</span><span class="mi">431</span><span class="nv">a</span><span class="o">-</span><span class="nv">a0e1</span><span class="o">-</span><span class="mi">171</span><span class="nv">a423abeb6</span><span class="w"></span>
<span class="nv">roleRef</span>:<span class="w"></span>
<span class="w">  </span><span class="nv">apiGroup</span>:<span class="w"> </span><span class="nv">rbac</span>.<span class="nv">authorization</span>.<span class="nv">k8s</span>.<span class="nv">io</span><span class="w"></span>
<span class="w">  </span><span class="nv">kind</span>:<span class="w"> </span><span class="nv">ClusterRole</span><span class="w"></span>
<span class="w">  </span><span class="nv">name</span>:<span class="w"> </span><span class="nv">system</span>:<span class="nv">discovery</span><span class="w"></span>
<span class="nv">subjects</span>:<span class="w"></span>
<span class="o">-</span><span class="w"> </span><span class="nv">apiGroup</span>:<span class="w"> </span><span class="nv">rbac</span>.<span class="nv">authorization</span>.<span class="nv">k8s</span>.<span class="nv">io</span><span class="w"></span>
<span class="w">  </span><span class="nv">kind</span>:<span class="w"> </span><span class="nv">Group</span><span class="w"></span>
<span class="w">  </span><span class="nv">name</span>:<span class="w"> </span><span class="nv">system</span>:<span class="nv">authenticated</span><span class="w"></span>
<span class="o">-</span><span class="w"> </span><span class="nv">apiGroup</span>:<span class="w"> </span><span class="nv">rbac</span>.<span class="nv">authorization</span>.<span class="nv">k8s</span>.<span class="nv">io</span><span class="w"></span>
<span class="w">  </span><span class="nv">kind</span>:<span class="w"> </span><span class="nv">Group</span><span class="w"></span>
<span class="w">  </span><span class="nv">name</span>:<span class="w"> </span><span class="nv">system</span>:<span class="nv">unauthenticated</span><span class="w"></span>
</code></pre></div>

<p>Delete the entry for system:unauthenticated group from the “subjects” section in the above editor screen. </p>
<p>Repeat the same steps for system:basic-user ClusterRoleBinding.</p>
<h3 id="alternative-approaches">Alternative approaches<a class="headerlink" href="#alternative-approaches" title="Permanent link">&para;</a></h3>
<p>While IRSA is the <em>preferred way</em> to assign an AWS "identity" to a pod, it requires that you include recent version of the AWS SDKs in your application. For a complete listing of the SDKs that currently support IRSA, see <a href="https://docs.aws.amazon.com/eks/latest/userguide/iam-roles-for-service-accounts-minimum-sdk.html">https://docs.aws.amazon.com/eks/latest/userguide/iam-roles-for-service-accounts-minimum-sdk.html</a>. If you have an application that you can't immediately update with a IRSA-compatible SDK, there are several community-built solutions available for assigning IAM roles to Kubernetes pods, including <a href="https://github.com/jtblin/kube2iam">kube2iam</a> and <a href="https://github.com/uswitch/kiam">kiam</a>.  Although AWS doesn't endorse or condone the use of these solutions, they are frequently used by the community at large to achieve similar results as IRSA. </p>


  




                
              </article>
            </div>
          
          
        </div>
        
      </main>
      
        <footer class="md-footer">
  
    
    <nav class="md-footer__inner md-grid" aria-label="Footer" >
      
        
        <a href="../" class="md-footer__link md-footer__link--prev" aria-label="Previous: Home" rel="prev">
          <div class="md-footer__button md-icon">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"/></svg>
          </div>
          <div class="md-footer__title">
            <div class="md-ellipsis">
              <span class="md-footer__direction">
                Previous
              </span>
              Home
            </div>
          </div>
        </a>
      
      
        
        <a href="../pods/" class="md-footer__link md-footer__link--next" aria-label="Next: Pod Security" rel="next">
          <div class="md-footer__title">
            <div class="md-ellipsis">
              <span class="md-footer__direction">
                Next
              </span>
              Pod Security
            </div>
          </div>
          <div class="md-footer__button md-icon">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M4 11v2h12l-5.5 5.5 1.42 1.42L19.84 12l-7.92-7.92L10.5 5.5 16 11H4Z"/></svg>
          </div>
        </a>
      
    </nav>
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    <script id="__config" type="application/json">{"base": "../../..", "features": ["tabs"], "search": "../../../assets/javascripts/workers/search.5bf1dace.min.js", "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.config.lang": "en", "search.config.pipeline": "trimmer, stopWordFilter", "search.config.separator": "[\\s\\-]+", "search.placeholder": "Search", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version.title": "Select version"}}</script>
    
    
      <script src="../../../assets/javascripts/bundle.37e9125f.min.js"></script>
      
    
  </body>
</html>