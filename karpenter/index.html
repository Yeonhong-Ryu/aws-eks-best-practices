
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
      <link rel="icon" href="../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.4.0, mkdocs-material-8.5.3">
    
    
      
        <title>Karpenter - EKS Best Practices Guides</title>
      
    
    
      <link rel="stylesheet" href="../assets/stylesheets/main.7a952b86.min.css">
      
        
        <link rel="stylesheet" href="../assets/stylesheets/palette.cbb835fc.min.css">
        
      
      

    
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
    <script>__md_scope=new URL("..",location),__md_hash=e=>[...e].reduce((e,_)=>(e<<5)-e+_.charCodeAt(0),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      
  


  
  


  <script id="__analytics">function __md_analytics(){function n(){dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],n("js",new Date),n("config","G-VQGL8B2FH8"),document.addEventListener("DOMContentLoaded",function(){document.forms.search&&document.forms.search.query.addEventListener("blur",function(){this.value&&n("event","search",{search_term:this.value})}),document$.subscribe(function(){var a=document.forms.feedback;if(void 0!==a)for(var e of a.querySelectorAll("[type=submit]"))e.addEventListener("click",function(e){e.preventDefault();var t=document.location.pathname,e=this.getAttribute("data-md-value");n("event","feedback",{page:t,data:e}),a.firstElementChild.disabled=!0;e=a.querySelector(".md-feedback__note [data-md-value='"+e+"']");e&&(e.hidden=!1)}),a.hidden=!1}),location$.subscribe(function(e){n("config","G-VQGL8B2FH8",{page_path:e.pathname})})});var e=document.createElement("script");e.async=!0,e.src="https://www.googletagmanager.com/gtag/js?id=G-VQGL8B2FH8",document.getElementById("__analytics").insertAdjacentElement("afterEnd",e)}</script>

  
    <script>"undefined"!=typeof __md_analytics&&__md_analytics()</script>
  

    
    
    
  </head>
  
  
    
    
    
    
    
    <body dir="ltr" data-md-color-scheme="" data-md-color-primary="none" data-md-color-accent="none">
  
    
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#karpenter-best-practices" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

<header class="md-header" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href=".." title="EKS Best Practices Guides" class="md-header__button md-logo" aria-label="EKS Best Practices Guides" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54Z"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2Z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            EKS Best Practices Guides
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              Karpenter
            
          </span>
        </div>
      </div>
    </div>
    
    
    
      <label class="md-header__button md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
      </label>
      <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41Z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
      <div class="md-header__source">
        <a href="https://github.com/aws/aws-eks-best-practices" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 496 512"><!--! Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc.--><path d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6zm-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3zm44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9zM244.8 8C106.1 8 0 113.3 0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8zM97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1zm-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7zm32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1zm-11.4-14.7c-1.6 1-1.6 3.6 0 5.9 1.6 2.3 4.3 3.3 5.6 2.3 1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2z"/></svg>
  </div>
  <div class="md-source__repository">
    aws/aws-eks-best-practices
  </div>
</a>
      </div>
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    


<nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href=".." title="EKS Best Practices Guides" class="md-nav__button md-logo" aria-label="EKS Best Practices Guides" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54Z"/></svg>

    </a>
    EKS Best Practices Guides
  </label>
  
    <div class="md-nav__source">
      <a href="https://github.com/aws/aws-eks-best-practices" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 496 512"><!--! Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc.--><path d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6zm-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3zm44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9zM244.8 8C106.1 8 0 113.3 0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8zM97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1zm-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7zm32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1zm-11.4-14.7c-1.6 1-1.6 3.6 0 5.9 1.6 2.3 4.3 3.3 5.6 2.3 1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2z"/></svg>
  </div>
  <div class="md-source__repository">
    aws/aws-eks-best-practices
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_1" type="checkbox" id="__nav_1" >
      
      
      
      
        <label class="md-nav__link" for="__nav_1">
          Guides
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Guides" data-md-level="1">
        <label class="md-nav__title" for="__nav_1">
          <span class="md-nav__icon md-icon"></span>
          Guides
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href=".." class="md-nav__link">
        Introduction
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_2" type="checkbox" id="__nav_2" >
      
      
      
      
        <label class="md-nav__link" for="__nav_2">
          Security
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Security" data-md-level="1">
        <label class="md-nav__title" for="__nav_2">
          <span class="md-nav__icon md-icon"></span>
          Security
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../security/docs/" class="md-nav__link">
        Home
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../security/docs/iam/" class="md-nav__link">
        Identity and Access Management
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../security/docs/pods/" class="md-nav__link">
        Pod Security
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../security/docs/multitenancy/" class="md-nav__link">
        Multi-tenancy
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../security/docs/detective/" class="md-nav__link">
        Detective Controls
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../security/docs/network/" class="md-nav__link">
        Network Security
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../security/docs/data/" class="md-nav__link">
        Data Encryption and Secrets Management
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../security/docs/runtime/" class="md-nav__link">
        Runtime Security
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../security/docs/hosts/" class="md-nav__link">
        Infrastructure Security
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../security/docs/compliance/" class="md-nav__link">
        Regulatory Compliance
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../security/docs/incidents/" class="md-nav__link">
        Incident Response and Forensics
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../security/docs/image/" class="md-nav__link">
        Image Security
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
    
  
  
    
    <li class="md-nav__item md-nav__item--active md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_3" type="checkbox" id="__nav_3" checked>
      
      
      
      
        <label class="md-nav__link" for="__nav_3">
          Cluster Autoscaling
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Cluster Autoscaling" data-md-level="1">
        <label class="md-nav__title" for="__nav_3">
          <span class="md-nav__icon md-icon"></span>
          Cluster Autoscaling
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
    
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" data-md-toggle="toc" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          Karpenter
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        Karpenter
      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#karpenter" class="md-nav__link">
    Karpenter
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#recommendations" class="md-nav__link">
    Recommendations
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#karpenter-best-practices_1" class="md-nav__link">
    Karpenter best practices
  </a>
  
    <nav class="md-nav" aria-label="Karpenter best practices">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#use-karpenter-for-workloads-with-changing-capacity-needs" class="md-nav__link">
    Use Karpenter for workloads with changing capacity needs
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#consider-other-autoscaling-projects-when" class="md-nav__link">
    Consider other autoscaling projects when...
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#run-the-karpenter-controller-on-eks-fargate-or-on-a-worker-node-that-belongs-to-a-node-group" class="md-nav__link">
    Run the Karpenter controller on EKS Fargate or on a worker node that belongs to a node group
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#avoid-using-custom-launch-templates-with-karpenter" class="md-nav__link">
    Avoid using custom launch templates with Karpenter
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#exclude-instance-types-that-do-not-fit-your-workload" class="md-nav__link">
    Exclude instance types that do not fit your workload
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#install-the-aws-node-termination-handler-when-using-spot" class="md-nav__link">
    Install the AWS Node Termination Handler when using Spot
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#amazon-eks-private-cluster-without-outbound-internet-access" class="md-nav__link">
    Amazon EKS private cluster without outbound internet access
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#creating-provisioners" class="md-nav__link">
    Creating provisioners
  </a>
  
    <nav class="md-nav" aria-label="Creating provisioners">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#create-multiple-provisioners-when" class="md-nav__link">
    Create multiple provisioners when...
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#create-provisioners-that-are-mutually-exclusive-or-weighted" class="md-nav__link">
    Create provisioners that are mutually exclusive or weighted
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#use-timers-ttl-to-automatically-delete-nodes-from-the-cluster" class="md-nav__link">
    Use timers (TTL) to automatically delete nodes from the cluster
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#avoid-overly-constraining-the-instance-types-that-karpenter-can-provision-especially-when-utilizing-spot" class="md-nav__link">
    Avoid overly constraining the Instance Types that Karpenter can provision, especially when utilizing Spot
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#scheduling-pods" class="md-nav__link">
    Scheduling Pods
  </a>
  
    <nav class="md-nav" aria-label="Scheduling Pods">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#follow-eks-best-practices-for-high-availability" class="md-nav__link">
    Follow EKS best practices for high availability
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#use-layered-constraints-to-constrain-the-compute-features-available-from-your-cloud-provider" class="md-nav__link">
    Use layered Constraints to constrain the compute features available from your cloud provider
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#create-billing-alarms-to-monitor-your-compute-spend" class="md-nav__link">
    Create billing alarms to monitor your compute spend
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#use-the-do-not-evict-annotation-to-prevent-karpenter-from-deprovisioning-a-node" class="md-nav__link">
    Use the do-not-evict annotation to prevent Karpenter from deprovisioning a node
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#configure-the-node-termination-handler-to-use-queue-processor-mode" class="md-nav__link">
    Configure the Node Termination Handler to use queue processor mode
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#configure-requestslimits-for-all-non-cpu-resources-when-using-consolidation" class="md-nav__link">
    Configure requests=limits for all non-CPU resources when using consolidation
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#use-limitranges-to-configure-defaults-for-resource-requests-and-limits" class="md-nav__link">
    Use LimitRanges to configure defaults for resource requests and limits
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#apply-accurate-resource-requests-to-all-workloads" class="md-nav__link">
    Apply accurate resource requests to all workloads
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#additional-resources" class="md-nav__link">
    Additional Resources
  </a>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../cluster-autoscaling/" class="md-nav__link">
        Cluster-Autoscaler
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_4" type="checkbox" id="__nav_4" >
      
      
      
      
        <label class="md-nav__link" for="__nav_4">
          Reliability
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Reliability" data-md-level="1">
        <label class="md-nav__title" for="__nav_4">
          <span class="md-nav__icon md-icon"></span>
          Reliability
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../reliability/docs/" class="md-nav__link">
        Home
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../reliability/docs/application/" class="md-nav__link">
        Applications
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../reliability/docs/controlplane/" class="md-nav__link">
        Control Plane
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../reliability/docs/dataplane/" class="md-nav__link">
        Data Plane
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../reliability/docs/networkmanagement/" class="md-nav__link">
        Network
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_5" type="checkbox" id="__nav_5" >
      
      
      
      
        <label class="md-nav__link" for="__nav_5">
          Windows Containers
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Windows Containers" data-md-level="1">
        <label class="md-nav__title" for="__nav_5">
          <span class="md-nav__icon md-icon"></span>
          Windows Containers
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../windows/docs/ami/" class="md-nav__link">
        AMI Management
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../windows/docs/gmsa/" class="md-nav__link">
        gMSA for Windows Containers
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../windows/docs/hardening/" class="md-nav__link">
        Windows Server Hardening
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../windows/docs/heterogeneous/" class="md-nav__link">
        Running Mixed Workloads
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../windows/docs/images/" class="md-nav__link">
        Scanning Windows Images
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../windows/docs/licensing/" class="md-nav__link">
        Windows Versions and Licensing
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../windows/docs/logging/" class="md-nav__link">
        Logging
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../windows/docs/monitoring/" class="md-nav__link">
        Monitoring Windows Containers
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../windows/docs/networking/" class="md-nav__link">
        Windows Networking
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../windows/docs/oom/" class="md-nav__link">
        Memory and Systems Management
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../windows/docs/patching/" class="md-nav__link">
        Infrastructure Management
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../windows/docs/scheduling/" class="md-nav__link">
        Scheduling
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../windows/docs/security/" class="md-nav__link">
        Pod Security for Windows Containers
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../windows/docs/storage/" class="md-nav__link">
        Storage Options
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_6" type="checkbox" id="__nav_6" >
      
      
      
      
        <label class="md-nav__link" for="__nav_6">
          Networking
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Networking" data-md-level="1">
        <label class="md-nav__title" for="__nav_6">
          <span class="md-nav__icon md-icon"></span>
          Networking
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../networking/index/" class="md-nav__link">
        Home
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../networking/subnets/" class="md-nav__link">
        VPC and Subnet Considerations
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../networking/vpc-cni/" class="md-nav__link">
        Amazon VPC CNI
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../networking/prefix-mode/" class="md-nav__link">
        Prefix Mode
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../networking/ipv6/" class="md-nav__link">
        Running IPv6 Clusters
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../networking/sgpp/" class="md-nav__link">
        Security Groups per Pod
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../networking/custom-networking/" class="md-nav__link">
        Custom Networking
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../networking/loadbalancing/loadbalancing/" class="md-nav__link">
        Load Balancing
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#karpenter" class="md-nav__link">
    Karpenter
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#recommendations" class="md-nav__link">
    Recommendations
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#karpenter-best-practices_1" class="md-nav__link">
    Karpenter best practices
  </a>
  
    <nav class="md-nav" aria-label="Karpenter best practices">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#use-karpenter-for-workloads-with-changing-capacity-needs" class="md-nav__link">
    Use Karpenter for workloads with changing capacity needs
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#consider-other-autoscaling-projects-when" class="md-nav__link">
    Consider other autoscaling projects when...
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#run-the-karpenter-controller-on-eks-fargate-or-on-a-worker-node-that-belongs-to-a-node-group" class="md-nav__link">
    Run the Karpenter controller on EKS Fargate or on a worker node that belongs to a node group
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#avoid-using-custom-launch-templates-with-karpenter" class="md-nav__link">
    Avoid using custom launch templates with Karpenter
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#exclude-instance-types-that-do-not-fit-your-workload" class="md-nav__link">
    Exclude instance types that do not fit your workload
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#install-the-aws-node-termination-handler-when-using-spot" class="md-nav__link">
    Install the AWS Node Termination Handler when using Spot
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#amazon-eks-private-cluster-without-outbound-internet-access" class="md-nav__link">
    Amazon EKS private cluster without outbound internet access
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#creating-provisioners" class="md-nav__link">
    Creating provisioners
  </a>
  
    <nav class="md-nav" aria-label="Creating provisioners">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#create-multiple-provisioners-when" class="md-nav__link">
    Create multiple provisioners when...
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#create-provisioners-that-are-mutually-exclusive-or-weighted" class="md-nav__link">
    Create provisioners that are mutually exclusive or weighted
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#use-timers-ttl-to-automatically-delete-nodes-from-the-cluster" class="md-nav__link">
    Use timers (TTL) to automatically delete nodes from the cluster
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#avoid-overly-constraining-the-instance-types-that-karpenter-can-provision-especially-when-utilizing-spot" class="md-nav__link">
    Avoid overly constraining the Instance Types that Karpenter can provision, especially when utilizing Spot
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#scheduling-pods" class="md-nav__link">
    Scheduling Pods
  </a>
  
    <nav class="md-nav" aria-label="Scheduling Pods">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#follow-eks-best-practices-for-high-availability" class="md-nav__link">
    Follow EKS best practices for high availability
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#use-layered-constraints-to-constrain-the-compute-features-available-from-your-cloud-provider" class="md-nav__link">
    Use layered Constraints to constrain the compute features available from your cloud provider
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#create-billing-alarms-to-monitor-your-compute-spend" class="md-nav__link">
    Create billing alarms to monitor your compute spend
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#use-the-do-not-evict-annotation-to-prevent-karpenter-from-deprovisioning-a-node" class="md-nav__link">
    Use the do-not-evict annotation to prevent Karpenter from deprovisioning a node
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#configure-the-node-termination-handler-to-use-queue-processor-mode" class="md-nav__link">
    Configure the Node Termination Handler to use queue processor mode
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#configure-requestslimits-for-all-non-cpu-resources-when-using-consolidation" class="md-nav__link">
    Configure requests=limits for all non-CPU resources when using consolidation
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#use-limitranges-to-configure-defaults-for-resource-requests-and-limits" class="md-nav__link">
    Use LimitRanges to configure defaults for resource requests and limits
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#apply-accurate-resource-requests-to-all-workloads" class="md-nav__link">
    Apply accurate resource requests to all workloads
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#additional-resources" class="md-nav__link">
    Additional Resources
  </a>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  

  <a href="https://github.com/aws/aws-eks-best-practices/edit/master/docs/karpenter/index.md" title="Edit this page" class="md-content__button md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20.71 7.04c.39-.39.39-1.04 0-1.41l-2.34-2.34c-.37-.39-1.02-.39-1.41 0l-1.84 1.83 3.75 3.75M3 17.25V21h3.75L17.81 9.93l-3.75-3.75L3 17.25Z"/></svg>
  </a>


<h1 id="karpenter-best-practices">Karpenter Best Practices<a class="headerlink" href="#karpenter-best-practices" title="Permanent link">&para;</a></h1>
<h2 id="karpenter">Karpenter<a class="headerlink" href="#karpenter" title="Permanent link">&para;</a></h2>
<p>Karpenter is an open-source cluster autoscaler that automatically provisions new nodes in response to unschedulable pods. Karpenter evaluates the aggregate resource requirements of the pending pods and chooses the optimal instance type to run them. It will automatically scale-in or terminate instances that don’t have any non-daemonset pods to reduce waste. It also supports a consolidation feature which will actively move pods around and either delete or replace nodes with cheaper versions to reduce cluster cost.</p>
<p><strong>Reasons to use Karpenter</strong></p>
<p>Before the launch of Karpenter, Kubernetes users relied primarily on <a href="https://docs.aws.amazon.com/autoscaling/ec2/userguide/AutoScalingGroup.html">Amazon EC2 Auto Scaling groups</a> and the <a href="https://github.com/kubernetes/autoscaler/tree/master/cluster-autoscaler">Kubernetes Cluster Autoscaler</a> (CAS) to dynamically adjust the compute capacity of their clusters. With Karpenter, you don’t need to create dozens of node groups to achieve the flexibility and diversity you get with Karpenter. Moreover, Karpenter is not as tightly coupled to Kubernetes versions (as CAS is) and doesn’t require you to jump between AWS and Kubernetes APIs.</p>
<p>Karpenter consolidates instance orchestration responsibilities within a single system, which is simpler, more stable and cluster-aware. Karpenter was designed to overcome some of the challenges presented by Cluster Autoscaler by providing simplified ways to:</p>
<ul>
<li>Provision nodes based on workload requirements.</li>
<li>Create diverse node configurations by instance type, using flexible workload provisioner options. Instead of managing many specific custom node groups, Karpenter could let you manage diverse workload capacity with a single, flexible provisioner.</li>
<li>Achieve improved pod scheduling at scale by quickly launching nodes and scheduling pods.</li>
</ul>
<p>For information and documentation on using Karpenter, visit the <a href="https://karpenter.sh/">karpenter.sh</a> site.</p>
<h2 id="recommendations">Recommendations<a class="headerlink" href="#recommendations" title="Permanent link">&para;</a></h2>
<p>Best practices are divided into sections on Karpenter itself, provisioners, and pod scheduling.</p>
<h2 id="karpenter-best-practices_1">Karpenter best practices<a class="headerlink" href="#karpenter-best-practices_1" title="Permanent link">&para;</a></h2>
<p>The following best practices cover topics related to Karpenter itself.</p>
<h3 id="use-karpenter-for-workloads-with-changing-capacity-needs">Use Karpenter for workloads with changing capacity needs<a class="headerlink" href="#use-karpenter-for-workloads-with-changing-capacity-needs" title="Permanent link">&para;</a></h3>
<p>Karpenter brings scaling management closer to Kubernetes native APIs than do <a href="https://aws.amazon.com/blogs/containers/amazon-eks-cluster-multi-zone-auto-scaling-groups/">Autoscaling Groups</a> (ASGs) and <a href="https://docs.aws.amazon.com/eks/latest/userguide/managed-node-groups.html">Managed Node Groups</a> (MNGs). ASGs and MNGs are AWS-native abstractions where scaling is triggered based on AWS level metrics, such as EC2 CPU load. <a href="https://docs.aws.amazon.com/eks/latest/userguide/autoscaling.html#cluster-autoscaler">Cluster Autoscaler</a> bridges the Kubernetes abstractions into AWS abstractions, but loses some flexibility because of that, such as scheduling for a specific availability zone.</p>
<p>Karpenter removes a layer of AWS abstraction to bring some of the flexibility directly into Kubernetes. Karpenter is best used for clusters with workloads that encounter periods of high, spiky demand or have diverse compute requirements. MNGs and ASGs are good for clusters running workloads that tend to be more static and consistent.  You can use a mix of dynamically and statically managed nodes, depending on your requirements.</p>
<h3 id="consider-other-autoscaling-projects-when">Consider other autoscaling projects when...<a class="headerlink" href="#consider-other-autoscaling-projects-when" title="Permanent link">&para;</a></h3>
<p>You need features that are still being developed in Karpenter. Because Karpenter is a relatively new project, consider other autoscaling projects for the time being if you have a need for features that are not yet part of Karpenter.</p>
<h3 id="run-the-karpenter-controller-on-eks-fargate-or-on-a-worker-node-that-belongs-to-a-node-group">Run the Karpenter controller on EKS Fargate or on a worker node that belongs to a node group<a class="headerlink" href="#run-the-karpenter-controller-on-eks-fargate-or-on-a-worker-node-that-belongs-to-a-node-group" title="Permanent link">&para;</a></h3>
<p>Karpenter is installed using a <a href="https://karpenter.sh/v0.10.0/getting-started/">Helm chart</a>. The Helm chart installs the Karpenter controller and a webhook pod as a Deployment that needs to run before the controller can be used for scaling your cluster. We recommend a minimum of one small node group with at least one worker node. As an alternative, you can run these pods on EKS Fargate by creating a Fargate profile for the <code>karpenter</code> namespace. Doing so will cause all pods deployed into this namespace to run on EKS Fargate. Do not run Karpenter on a node that is managed by Karpenter.</p>
<h3 id="avoid-using-custom-launch-templates-with-karpenter">Avoid using custom launch templates with Karpenter<a class="headerlink" href="#avoid-using-custom-launch-templates-with-karpenter" title="Permanent link">&para;</a></h3>
<p>Karpenter strongly recommends against using custom launch templates. Using custom launch templates prevents multi-architecture support, the ability to automatically upgrade nodes, and securityGroup discovery. Using launch templates may also cause confusion because certain fields are duplicated within Karpenter’s provisioners while others are ignored by Karpenter, e.g. subnets and instance types.</p>
<p>You can often avoid using launch templates by using custom user data and/or directly specifying custom AMIs in the AWS node template.  More information on how to do this is available at <a href="https://karpenter.sh/preview/aws/user-data/">Customer User Data and Ami</a>.</p>
<p>Granted, there may be times when you will want to use your own custom launch template, rather than using what Karpenter uses by default. The reasons to create custom launch templates may include the need to:</p>
<ul>
<li>Integrate with existing infrastructure.</li>
<li>Meet compliance requirements.</li>
</ul>
<p>To learn more, see <a href="https://karpenter.sh/preview/aws/launch-templates/">Launch Templates and Custom Images</a> in the Karpenter documentation. For background on building custom AMIs, see <a href="https://www.sufle.io/blog/custom-amazon-eks-ami-build">Amazon EKS AMI Build using EC2 Image Builder</a>, <a href="https://github.com/awslabs/amazon-eks-ami">Packer scripts</a>, and <a href="https://aws.amazon.com/premiumsupport/knowledge-center/eks-custom-linux-ami/">Create custom Amazon Linux AMIs for Amazon EKS</a>.</p>
<h3 id="exclude-instance-types-that-do-not-fit-your-workload">Exclude instance types that do not fit your workload<a class="headerlink" href="#exclude-instance-types-that-do-not-fit-your-workload" title="Permanent link">&para;</a></h3>
<p>Consider excluding specific instances types with the <a href="http://node.kubernetes.io/instance-type">node.kubernetes.io/instance-type</a> key if they are not required by workloads running in your cluster.</p>
<p>The following example shows how to avoid provisioning large Graviton instances.</p>
<div class="codehilite"><pre><span></span><code><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">key</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">node.kubernetes.io/instance-type</span><span class="w"></span>
<span class="w">    </span><span class="l l-Scalar l-Scalar-Plain">operator</span><span class="p p-Indicator">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">NotIn</span><span class="w"></span>
<span class="w">    </span><span class="l l-Scalar l-Scalar-Plain">values</span><span class="p p-Indicator">:</span><span class="w"></span>
<span class="w">      </span><span class="s">&#39;m6g.16xlarge&#39;</span><span class="w"></span>
<span class="w">      </span><span class="s">&#39;m6gd.16xlarge&#39;</span><span class="w"></span>
<span class="w">      </span><span class="s">&#39;r6g.16xlarge&#39;</span><span class="w"></span>
<span class="w">      </span><span class="s">&#39;r6gd.16xlarge&#39;</span><span class="w"></span>
<span class="w">      </span><span class="s">&#39;c6g.16xlarge&#39;</span><span class="w"></span>
</code></pre></div>

<h3 id="install-the-aws-node-termination-handler-when-using-spot">Install the AWS Node Termination Handler when using Spot<a class="headerlink" href="#install-the-aws-node-termination-handler-when-using-spot" title="Permanent link">&para;</a></h3>
<p>At present, Karpenter does not handle the Spot Interruption Termination Notice (ITN) two-minute warning. In lieu of this, you can install <a href="https://github.com/aws/aws-node-termination-handler">AWS Node Termination Handler</a> to gracefully cordon and drain your spot nodes when they are interrupted.
 Pods that require checkpointing or other forms of graceful draining, requiring the 2-mins before shutdown, will need NTH.</p>
<h3 id="amazon-eks-private-cluster-without-outbound-internet-access"><strong>Amazon EKS private cluster without outbound internet access</strong><a class="headerlink" href="#amazon-eks-private-cluster-without-outbound-internet-access" title="Permanent link">&para;</a></h3>
<p>When provisioning an EKS Cluster into a VPC with no route to the internet, you have to make sure you’ve configured your environment in accordance with the private cluster <a href="https://docs.aws.amazon.com/eks/latest/userguide/private-clusters.html#private-cluster-requirements">requirements</a> that appear in EKS documentation. In addition, you need to make sure you’ve created an STS VPC regional endpoint in your VPC. If not, you will see errors similar to those that appear below.</p>
<div class="codehilite"><pre><span></span><code><span class="go">ERROR controller.controller.metrics Reconciler error {&quot;commit&quot;: &quot;5047f3c&quot;, &quot;reconciler group&quot;: &quot;karpenter.sh&quot;, &quot;reconciler kind&quot;: &quot;Provisioner&quot;, &quot;name&quot;: &quot;default&quot;, &quot;namespace&quot;: &quot;&quot;, &quot;error&quot;: &quot;fetching instance types using ec2.DescribeInstanceTypes, WebIdentityErr: failed to retrieve credentials\ncaused by: RequestError: send request failed\ncaused by: Post \&quot;https://sts.&lt;region&gt;.amazonaws.com/\&quot;: dial tcp x.x.x.x:443: i/o timeout&quot;}</span>
</code></pre></div>

<p>These changes are necessary in a private cluster because the Karpenter Controller uses IAM Roles for Service Accounts (IRSA). Pods configured with IRSA acquire credentials by calling the AWS Security Token Service (AWS STS) API. If there is no outbound internet access, you must create and use an <strong><em>AWS STS VPC endpoint in your VPC</em></strong>.</p>
<p>Private clusters also require you to create a <strong><em>VPC endpoint for SSM</em></strong>. When Karpenter tries to provision a new node, it queries the Launch template configs and an SSM parameter. If you do not have a SSM VPC endpoint in your VPC, it will cause the following error:</p>
<div class="codehilite"><pre><span></span><code><span class="go">INFO    controller.provisioning Waiting for unschedulable pods  {&quot;commit&quot;: &quot;5047f3c&quot;, &quot;provisioner&quot;: &quot;default&quot;}</span>
<span class="go">INFO    controller.provisioning Batched 3 pods in 1.000572709s  {&quot;commit&quot;: &quot;5047f3c&quot;, &quot;provisioner&quot;: &quot;default&quot;}</span>
<span class="go">INFO    controller.provisioning Computed packing of 1 node(s) for 3 pod(s) with instance type option(s) [c4.xlarge c6i.xlarge c5.xlarge c5d.xlarge c5a.xlarge c5n.xlarge m6i.xlarge m4.xlarge m6a.xlarge m5ad.xlarge m5d.xlarge t3.xlarge m5a.xlarge t3a.xlarge m5.xlarge r4.xlarge r3.xlarge r5ad.xlarge r6i.xlarge r5a.xlarge]        {&quot;commit&quot;: &quot;5047f3c&quot;, &quot;provisioner&quot;: &quot;default&quot;}</span>
<span class="go">ERROR   controller.provisioning Could not launch node, launching instances, getting launch template configs, getting launch templates, getting ssm parameter, RequestError: send request failed</span>
<span class="go">caused by: Post &quot;https://ssm.&lt;region&gt;.amazonaws.com/&quot;: dial tcp x.x.x.x:443: i/o timeout  {&quot;commit&quot;: &quot;5047f3c&quot;, &quot;provisioner&quot;: &quot;default&quot;}</span>
</code></pre></div>

<p>There is no <strong><em>VPC endpoint for the <a href="https://docs.aws.amazon.com/awsaccountbilling/latest/aboutv2/using-pelong.html">Price List Query API</a></em></strong>.
As a result, pricing data will go stale over time.
Karpenter gets around this by including on-demand pricing data in its binary, but only updates that data when Karpenter is upgraded.
Failed requests for pricing data will result in the following error messages:</p>
<div class="codehilite"><pre><span></span><code><span class="go">ERROR   controller.aws.pricing  updating on-demand pricing, RequestError: send request failed</span>
<span class="go">caused by: Post &quot;https://api.pricing.us-east-1.amazonaws.com/&quot;: dial tcp 52.94.231.236:443: i/o timeout; RequestError: send request failed</span>
<span class="go">caused by: Post &quot;https://api.pricing.us-east-1.amazonaws.com/&quot;: dial tcp 52.94.231.236:443: i/o timeout, using existing pricing data from 2022-08-17T00:19:52Z  {&quot;commit&quot;: &quot;4b5f953&quot;}</span>
</code></pre></div>

<p>In summary, to use Karpenter in a completely Private EKS Clusters, you need to create the following VPC endpoints:</p>
<div class="codehilite"><pre><span></span><code><span class="go">com.amazonaws.&lt;region&gt;.ec2</span>
<span class="go">com.amazonaws.&lt;region&gt;.ecr.api</span>
<span class="go">com.amazonaws.&lt;region&gt;.ecr.dkr</span>
<span class="go">com.amazonaws.&lt;region&gt;.s3 – For pulling container images</span>
<span class="go">com.amazonaws.&lt;region&gt;.sts – For IAM roles for service accounts</span>
<span class="go">com.amazonaws.&lt;region&gt;.ssm - If using Karpenter</span>
</code></pre></div>

<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Karpenter (controller and webhook deployment) container images must be in or copied to Amazon ECR private or to a another private registry accessible from inside the VPC. The reason for this is that the Karpenter controller and webhook pods currently use Public ECR images. If these are not available from within the VPC, or from networks peered with the VPC, you will get Image pull errors when Kubernetes tries to pull these images from ECR public.</p>
</div>
<p>For further information, see <a href="https://github.com/aws/karpenter/issues/988">Issue 988</a> and <a href="https://github.com/aws/karpenter/issues/1157">Issue 1157</a>.</p>
<h2 id="creating-provisioners">Creating provisioners<a class="headerlink" href="#creating-provisioners" title="Permanent link">&para;</a></h2>
<p>The following best practices cover topics related to creating provisioners.</p>
<h3 id="create-multiple-provisioners-when">Create multiple provisioners when...<a class="headerlink" href="#create-multiple-provisioners-when" title="Permanent link">&para;</a></h3>
<p>When different teams are sharing a cluster and need to run their workloads on different worker nodes, or have different OS or instance type requirements, create multiple provisioners. For example, one team may want to use Bottlerocket, while another may want to use Amazon Linux. Likewise, one team might have access to expensive GPU hardware that wouldn’t be needed by another team. Using multiple provisioners makes sure that the most appropriate assets are available to each team.</p>
<h3 id="create-provisioners-that-are-mutually-exclusive-or-weighted">Create provisioners that are mutually exclusive or weighted<a class="headerlink" href="#create-provisioners-that-are-mutually-exclusive-or-weighted" title="Permanent link">&para;</a></h3>
<p>It is recommended to create Provisioners that are either mutually exclusive or weighted to provide consistent scheduling behavior. If they are not and multiple Provisioners are matched, Karpenter will randomly choose which to use, causing unexpected results. Useful examples for creating multiple provisioners include the following:</p>
<p>Creating a Provisioner with GPU and only allowing special workloads to run on these (expensive) nodes:</p>
<div class="codehilite"><pre><span></span><code><span class="c1"># Provisioner for GPU Instances with Taints</span><span class="w"></span>
<span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">karpenter.sh/v1alpha5</span><span class="w"></span>
<span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Provisioner</span><span class="w"></span>
<span class="nt">metadata</span><span class="p">:</span><span class="w"></span>
<span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">gpu</span><span class="w"></span>
<span class="nt">spec</span><span class="p">:</span><span class="w"></span>
<span class="w">  </span><span class="nt">requirements</span><span class="p">:</span><span class="w"></span>
<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">key</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">node.kubernetes.io/instance-type</span><span class="w"></span>
<span class="w">    </span><span class="nt">operator</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">In</span><span class="w"></span>
<span class="w">    </span><span class="nt">values</span><span class="p">:</span><span class="w"></span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">p3.8xlarge</span><span class="w"></span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">p3.16xlarge</span><span class="w"></span>
<span class="w">  </span><span class="nt">taints</span><span class="p">:</span><span class="w"></span>
<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">effect</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">NoSchedule</span><span class="w"></span>
<span class="w">    </span><span class="nt">key</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">nvidia.com/gpu</span><span class="w"></span>
<span class="w">    </span><span class="nt">value</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;true&quot;</span><span class="w"></span>
<span class="w">  </span><span class="nt">ttlSecondsAfterEmpty</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">60</span><span class="w"></span>
</code></pre></div>

<p>Deployment with toleration for the taint:</p>
<div class="codehilite"><pre><span></span><code><span class="c1"># Deployment of GPU Workload will have tolerations defined</span><span class="w"></span>
<span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">apps/v1</span><span class="w"></span>
<span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Deployment</span><span class="w"></span>
<span class="nt">metadata</span><span class="p">:</span><span class="w"></span>
<span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">inflate-gpu</span><span class="w"></span>
<span class="nt">spec</span><span class="p">:</span><span class="w"></span>
<span class="w">  </span><span class="l l-Scalar l-Scalar-Plain">...</span><span class="w"></span>
<span class="w">    </span><span class="l l-Scalar l-Scalar-Plain">spec</span><span class="p p-Indicator">:</span><span class="w"></span>
<span class="w">      </span><span class="nt">tolerations</span><span class="p">:</span><span class="w"></span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">key</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;nvidia.com/gpu&quot;</span><span class="w"></span>
<span class="w">        </span><span class="nt">operator</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;Exists&quot;</span><span class="w"></span>
<span class="w">        </span><span class="nt">effect</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;NoSchedule&quot;</span><span class="w"></span>
</code></pre></div>

<p>For a general deployment for another team, the provisioner spec could include nodeAffinify. A Deployment could then use nodeSelectorTerms to match <code>billing-team</code>.</p>
<div class="codehilite"><pre><span></span><code><span class="c1"># Provisioner for regular EC2 instances</span><span class="w"></span>
<span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">karpenter.sh/v1alpha5</span><span class="w"></span>
<span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Provisioner</span><span class="w"></span>
<span class="nt">metadata</span><span class="p">:</span><span class="w"></span>
<span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">generalcompute</span><span class="w"></span>
<span class="nt">spec</span><span class="p">:</span><span class="w"></span>
<span class="w">  </span><span class="nt">labels</span><span class="p">:</span><span class="w"></span>
<span class="w">    </span><span class="nt">billing-team</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">my-team</span><span class="w"></span>
<span class="w">  </span><span class="nt">requirements</span><span class="p">:</span><span class="w"></span>
<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">key</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">node.kubernetes.io/instance-type</span><span class="w"></span>
<span class="w">    </span><span class="nt">operator</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">In</span><span class="w"></span>
<span class="w">    </span><span class="nt">values</span><span class="p">:</span><span class="w"></span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">m5.large</span><span class="w"></span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">m5.xlarge</span><span class="w"></span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">m5.2xlarge</span><span class="w"></span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">c5.large</span><span class="w"></span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">c5.xlarge</span><span class="w"></span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">c5a.large</span><span class="w"></span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">c5a.xlarge</span><span class="w"></span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">r5.large</span><span class="w"></span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">r5.xlarge</span><span class="w"></span>
</code></pre></div>

<p>Deployment using nodeAffinity:</p>
<div class="codehilite"><pre><span></span><code><span class="c1"># Deployment will have spec.affinity.nodeAffinity defined</span><span class="w"></span>
<span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Deployment</span><span class="w"></span>
<span class="nt">metadata</span><span class="p">:</span><span class="w"></span>
<span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">workload-my-team</span><span class="w"></span>
<span class="nt">spec</span><span class="p">:</span><span class="w"></span>
<span class="w">  </span><span class="nt">replicas</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">200</span><span class="w"></span>
<span class="w">  </span><span class="l l-Scalar l-Scalar-Plain">...</span><span class="w"></span>
<span class="w">    </span><span class="l l-Scalar l-Scalar-Plain">spec</span><span class="p p-Indicator">:</span><span class="w"></span>
<span class="w">      </span><span class="nt">affinity</span><span class="p">:</span><span class="w"></span>
<span class="w">        </span><span class="nt">nodeAffinity</span><span class="p">:</span><span class="w"></span>
<span class="w">          </span><span class="nt">requiredDuringSchedulingIgnoredDuringExecution</span><span class="p">:</span><span class="w"></span>
<span class="w">            </span><span class="nt">nodeSelectorTerms</span><span class="p">:</span><span class="w"></span>
<span class="w">              </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">matchExpressions</span><span class="p">:</span><span class="w"></span>
<span class="w">                </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">key</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;billing-team&quot;</span><span class="w"></span>
<span class="w">                  </span><span class="nt">operator</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;In&quot;</span><span class="w"></span>
<span class="w">                  </span><span class="nt">values</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[</span><span class="s">&quot;my-team&quot;</span><span class="p p-Indicator">]</span><span class="w"></span>
</code></pre></div>

<h3 id="use-timers-ttl-to-automatically-delete-nodes-from-the-cluster">Use timers (TTL) to automatically delete nodes from the cluster<a class="headerlink" href="#use-timers-ttl-to-automatically-delete-nodes-from-the-cluster" title="Permanent link">&para;</a></h3>
<p>You can use timers on provisioned nodes to set when to delete nodes that are devoid of workload pods or have reached an expiration time. Node expiry can be used as a means of upgrading, so that nodes are retired and replaced with updated versions. See <a href="https://karpenter.sh/preview/tasks/deprovisioning/#how-karpenter-nodes-are-deprovisioned">How Karpenter nodes are deprovisioned</a> in the Karpenter documentation for information on using  <strong><code>ttlSecondsUntilExpired</code></strong> and <strong><code>ttlSecondsAfterEmpty</code></strong> to deprovision nodes.</p>
<h3 id="avoid-overly-constraining-the-instance-types-that-karpenter-can-provision-especially-when-utilizing-spot">Avoid overly constraining the Instance Types that Karpenter can provision, especially when utilizing Spot<a class="headerlink" href="#avoid-overly-constraining-the-instance-types-that-karpenter-can-provision-especially-when-utilizing-spot" title="Permanent link">&para;</a></h3>
<p>When using Spot, Karpenter uses the <a href="https://docs.aws.amazon.com/AWSEC2/latest/UserGuide/ec2-fleet-allocation-strategy.html">Capacity Optimized</a><a href="https://docs.aws.amazon.com/AWSEC2/latest/UserGuide/ec2-fleet-allocation-strategy.html">Prioritized allocation strategy</a> to provision EC2 instances. The Capacity Optimized allocation strategy will instruct EC2 to provision instances from deeper spot pools in order to decrease the likelihood of interruption. The more instance types you allow Karpenter to utilize, the better EC2 can optimize your spot instance’s runtime. By default, Karpenter will use all Instance Types EC2 offers in the region and availability zones your cluster is deployed in. Karpenter intelligently chooses from the set of all instance types based on pending pods to make sure your pods are scheduled onto appropriately sized and equipped instances. For example, if your pod does not require a GPU, Karpenter will not schedule your pod to an EC2 instance type supporting a GPU. When you're unsure about which instance types to use, you can run the Amazon <a href="https://github.com/aws/amazon-ec2-instance-selector">ec2-instance-selector</a> to generate a list of instance types that match your compute requirements. For example, the CLI takes memory vCPU, architecture, and region as input parameters and provides you with a list of EC2 instances that satisfy those constraints.</p>
<div class="codehilite"><pre><span></span><code><span class="gp">$ </span>ec2-instance-selector --memory <span class="m">4</span> --vcpus <span class="m">2</span> --cpu-architecture x86_64 -r ap-southeast-1
<span class="go">c5.large</span>
<span class="go">c5a.large</span>
<span class="go">c5ad.large</span>
<span class="go">c5d.large</span>
<span class="go">c6i.large</span>
<span class="go">t2.medium</span>
<span class="go">t3.medium</span>
<span class="go">t3a.medium</span>
</code></pre></div>

<p>You shouldn’t place too many constraints on Karpenter when using Spot instances because doing so can affect the availability of your applications. Say, for example, all of the instances of a particular type are reclaimed and there are no suitable alternatives available to replace them. Your pods will remain in a pending state until the spot capacity for the configured instance types is replenished. You can reduce the risk of insufficient capacity errors by spreading your instances across different availability zones, because spot pools are different across AZs. That said, the general best practice is to allow Karpenter to use a diverse set of instance types when using Spot.</p>
<h2 id="scheduling-pods">Scheduling Pods<a class="headerlink" href="#scheduling-pods" title="Permanent link">&para;</a></h2>
<p>The following best practices relate to deploying pods In a cluster using Karpenter for node provisioning.</p>
<h3 id="follow-eks-best-practices-for-high-availability">Follow EKS best practices for high availability<a class="headerlink" href="#follow-eks-best-practices-for-high-availability" title="Permanent link">&para;</a></h3>
<p>If you need to run highly available applications, follow general EKS best practice <a href="https://aws.github.io/aws-eks-best-practices/reliability/docs/application/#recommendations">recommendations</a>. See <a href="https://karpenter.sh/preview/tasks/scheduling/#topology-spread">Topology Spread</a> in Karpenter documentation for details on how to spread pods across nodes and zones. Use <a href="https://karpenter.sh/preview/tasks/deprovisioning/#disruption-budgets">Disruption Budgets</a> to set the minimum available pods that need to be maintained, in case there are attempts to evict or delete pods.</p>
<h3 id="use-layered-constraints-to-constrain-the-compute-features-available-from-your-cloud-provider">Use layered Constraints to constrain the compute features available from your cloud provider<a class="headerlink" href="#use-layered-constraints-to-constrain-the-compute-features-available-from-your-cloud-provider" title="Permanent link">&para;</a></h3>
<p>Karpenter’s model of layered constraints allows you to create a complex set of provisioner and pod deployment constraints to get the best possible matches for pod scheduling. Examples of constraints that a pod spec can request include the following:</p>
<ul>
<li>Needing to run in availability zones where only particular applications are available. Say, for example, you have pod that has to communicate with another application that runs on an EC2 instance residing in a particular availability zone. If your aim is to reduce cross-AZ traffic in your VPC, you may want to co-locate the pods in the AZ where the EC2 instance is located. This sort of targeting is often accomplished using node selectors. For additional information on <a href="https://karpenter.sh/preview/tasks/scheduling/#node-selectors">Node selectors</a>, please refer to the Kubernetes documentation.</li>
<li>Requiring certain kinds of processors or other hardware. See the <a href="https://karpenter.sh/v0.6.1/aws/provisioning/#accelerators-gpu">Accelerators</a> section of the Karpenter docs for a podspec example that requires the pod to run on a GPU processor.</li>
</ul>
<h3 id="create-billing-alarms-to-monitor-your-compute-spend">Create billing alarms to monitor your compute spend<a class="headerlink" href="#create-billing-alarms-to-monitor-your-compute-spend" title="Permanent link">&para;</a></h3>
<p>When you configure your cluster to automatically scale, you should create billing alarms to warn you when your spend has exceeded a threshold and add resource limits to your Karpenter configuration. Setting resource limits with Karpenter is similar to setting an AWS autoscaling group’s maximum capacity in that it represents the maximum amount of compute resources that can be instantiated by a Karpenter provisioner.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>It is not possible to set a global limit for the whole cluster. Limits apply to specific provisioners.</p>
</div>
<p>The snippet below tells Karpenter to only provision a maximum of 1000 CPU cores and 1000Gi of memory. Karpenter will stop adding capacity only when the limit is met or exceeded. When a limit is exceeded the Karpenter controller will write <code>memory resource usage of 1001 exceeds limit of 1000</code> or a similar looking message to the controller’s logs. If you are routing your container logs to CloudWatch logs, you can create a <a href="https://docs.aws.amazon.com/AmazonCloudWatch/latest/logs/MonitoringLogData.html">metrics filter</a> to look for specific patterns or terms in your logs and then create a <a href="https://docs.aws.amazon.com/AmazonCloudWatch/latest/monitoring/AlarmThatSendsEmail.html">CloudWatch alarm</a> to alert you when your configured metrics threshold is breached.</p>
<p>For further information using limits with Karpenter, see <a href="https://karpenter.sh/preview/tasks/set-resource-limits/">Setting Resource Limits</a> in the Karpenter documentation.</p>
<div class="codehilite"><pre><span></span><code><span class="nt">spec</span><span class="p">:</span><span class="w"></span>
<span class="w">  </span><span class="nt">limits</span><span class="p">:</span><span class="w"></span>
<span class="w">    </span><span class="nt">resources</span><span class="p">:</span><span class="w"></span>
<span class="w">      </span><span class="nt">cpu</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">1000</span><span class="w"></span>
<span class="w">      </span><span class="nt">memory</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">1000Gi</span><span class="w"></span>
</code></pre></div>

<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Setting GPU limits is not supported at this time.</p>
</div>
<p>If you don’t use limits or constrain the instance types that Karpenter can provision, Karpenter will continue adding compute capacity to your cluster as needed. While configuring Karpenter in this way allows your cluster to scale freely, it can also have significant cost implications. It is for this reason that we recommend that configuring billing alarms. Billing alarms allow you to be alerted and proactively notified when the calculated estimated charges in your account(s) exceed a defined threshold. See <a href="https://aws.amazon.com/blogs/mt/setting-up-an-amazon-cloudwatch-billing-alarm-to-proactively-monitor-estimated-charges/">Setting up an Amazon CloudWatch Billing Alarm to Proactively Monitor Estimated Charges</a> for additional information.</p>
<p>You may also want to enable Cost Anomaly Detection which is an AWS Cost Management feature that uses machine learning to continuously monitor your cost and usage to detect unusual spends. Further information can be found in the <a href="https://docs.aws.amazon.com/cost-management/latest/userguide/getting-started-ad.html">AWS Cost Anomaly Detection Getting Started</a> guide. If you’ve gone so far as to create a budget in AWS Budgets, you can also configure an action to notify you when a specific threshold has been breached. With budget actions you can send an email, post a message to an SNS topic, or send a message to a chatbot like Slack. For further information see <a href="https://docs.aws.amazon.com/cost-management/latest/userguide/budgets-controls.html">Configuring AWS Budgets actions</a>.</p>
<h3 id="use-the-do-not-evict-annotation-to-prevent-karpenter-from-deprovisioning-a-node">Use the do-not-evict annotation to prevent Karpenter from deprovisioning a node<a class="headerlink" href="#use-the-do-not-evict-annotation-to-prevent-karpenter-from-deprovisioning-a-node" title="Permanent link">&para;</a></h3>
<p>If you are running a critical application on a Karpenter-provisioned node, such as a <em>long running</em> batch job or stateful application, <em>and</em> the node’s TTL has expired, the application will be interrupted when the instance is terminated. By adding a <code>karpenter.sh/do-not-evict</code> annotation to the pod, you are instructing Karpenter to preserve the node until the Pod is terminated or the <code>do-not-evict</code> annotation is removed. See <a href="https://karpenter.sh/preview/tasks/deprovisioning/#pod-set-to-do-not-evict">Deprovisioning</a> documentation for further information.</p>
<p>If the only non-daemonset pods left on a node are those associated with jobs, Karpenter is able to target and terminate those nodes so long as the job status is succeed or failed.</p>
<h3 id="configure-the-node-termination-handler-to-use-queue-processor-mode">Configure the Node Termination Handler to use queue processor mode<a class="headerlink" href="#configure-the-node-termination-handler-to-use-queue-processor-mode" title="Permanent link">&para;</a></h3>
<p>Node Termination Handler operates in two modes, using Instance Metadata Services (IMDS) or using a Queue Processor. The IMDS service runs a pod on each node to monitor the events and act accordingly. Whereas the queue processor uses Amazon Simple Queue Service (Amazon SQS) to receive Auto Scaling Group (ASG) lifecycle events, EC2 status change events, Spot interruption termination notice events, and Spot rebalance recommendation events. These events can be configured to be published to Amazon EventBridge. In Karpenter’s case, Auto Scaling Group lifecycle events should not be considered because the instances provisioned using Karpenter are not part of an ASG.</p>
<p>When following the <a href="https://github.com/aws/aws-node-termination-handler#infrastructure-setup">installation instructions</a>, you can skip the steps for <strong>Set up a Termination Lifecycle Hook on an Auto Scaling group</strong> and <strong>Tag the Auto Scaling groups</strong> because instances provisioned by Karpenter do not belong to an autoscaling group. In the step <strong>Create Amazon Eventbridge Rules</strong>, skip the step to create Auto Scaling event rules. If you are deploying the Helm chart for the Node Termination Handler Queue Processor, use the following values:</p>
<div class="codehilite"><pre><span></span><code><span class="c1">## Queue processor values.yaml</span><span class="w"></span>

<span class="nt">enableSqsTerminationDraining</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">true</span><span class="w"></span>
<span class="nt">queueURL</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;&lt;specify</span><span class="nv"> </span><span class="s">your</span><span class="nv"> </span><span class="s">queue</span><span class="nv"> </span><span class="s">URl&gt;&quot;</span><span class="w"></span>
<span class="nt">awsRegion</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;&lt;specify</span><span class="nv"> </span><span class="s">your</span><span class="nv"> </span><span class="s">region&gt;&quot;</span><span class="w"></span>
<span class="nt">serviceAccount</span><span class="p">:</span><span class="w"></span>
<span class="w">  </span><span class="nt">create</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">false</span><span class="w"></span>
<span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">nth</span><span class="w"> </span><span class="c1"># &lt;-- adjust to your service account</span><span class="w"></span>
<span class="nt">checkASGTagBeforeDraining</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">false</span><span class="w"> </span><span class="c1"># &lt;-- set to false as instances do not belong to any ASG</span><span class="w"></span>
<span class="nt">enableSpotInterruptionDraining</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">true</span><span class="w"></span>
</code></pre></div>

<h3 id="configure-requestslimits-for-all-non-cpu-resources-when-using-consolidation">Configure requests=limits for all non-CPU resources when using consolidation<a class="headerlink" href="#configure-requestslimits-for-all-non-cpu-resources-when-using-consolidation" title="Permanent link">&para;</a></h3>
<p>Consolidation and scheduling in general work by comparing the pods resource requests vs the amount of allocatable resources on a node.  The resource limits are not considered.  As an example, pods that have a memory limit that is larger than the memory request can burst above the request.  If several pods on the same node burst at the same time, this can cause some of the pods to be terminated due to an out of memory (OOM) condition.  Consolidation can make this more likely to occur as it works to pack pods onto nodes only considering their requests.</p>
<h3 id="use-limitranges-to-configure-defaults-for-resource-requests-and-limits">Use LimitRanges to configure defaults for resource requests and limits<a class="headerlink" href="#use-limitranges-to-configure-defaults-for-resource-requests-and-limits" title="Permanent link">&para;</a></h3>
<p>Because Kubernetes doesn’t set default requests or limits, a container’s consumption of resources from the underlying host, CPU, and memory is unbound. The Kubernetes scheduler looks at a pod’s total requests (the higher of the total requests from the pod’s containers or the total resources from the pod’s Init containers) to determine which worker node to schedule the pod onto. Similarly, Karpenter considers a pod’s requests to determine which type of instance it provisions. You can use a limit range to apply a sensible default for a namespace, in case resource requests are not specified by some pods.</p>
<p>See <a href="https://kubernetes.io/docs/tasks/administer-cluster/manage-resources/memory-default-namespace/">Configure Default Memory Requests and Limits for a Namespace</a></p>
<h3 id="apply-accurate-resource-requests-to-all-workloads">Apply accurate resource requests to all workloads<a class="headerlink" href="#apply-accurate-resource-requests-to-all-workloads" title="Permanent link">&para;</a></h3>
<p>Karpenter is able to launch nodes that best fit your workloads when its information about your workloads requirements is accurate.  This is particularly important if using Karpenter's consolidation feature.</p>
<p>See <a href="https://aws.github.io/aws-eks-best-practices/reliability/docs/dataplane/#configure-and-size-resource-requestslimits-for-all-workloads">Configure and Size Resource Requests/Limits for all Workloads</a></p>
<h2 id="additional-resources">Additional Resources<a class="headerlink" href="#additional-resources" title="Permanent link">&para;</a></h2>
<ul>
<li><a href="https://ec2spotworkshops.com/karpenter.html">Karpenter/Spot Workshop</a></li>
<li><a href="https://youtu.be/_FXRIKWJWUk">Karpenter Node Provisioner</a></li>
<li><a href="https://youtu.be/zXqrNJaTCrU">TGIK Karpenter</a></li>
<li><a href="https://youtu.be/3QsVRHVdOnM">Karpenter vs. Cluster Autoscaler</a></li>
<li><a href="https://www.youtube.com/watch?v=43g8uPohTgc">Groupless Autoscaling with Karpenter</a></li>
</ul>


  




                
              </article>
            </div>
          
          
        </div>
        
      </main>
      
        <footer class="md-footer">
  
    
    <nav class="md-footer__inner md-grid" aria-label="Footer" >
      
        
        <a href="../security/docs/image/" class="md-footer__link md-footer__link--prev" aria-label="Previous: Image Security" rel="prev">
          <div class="md-footer__button md-icon">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"/></svg>
          </div>
          <div class="md-footer__title">
            <div class="md-ellipsis">
              <span class="md-footer__direction">
                Previous
              </span>
              Image Security
            </div>
          </div>
        </a>
      
      
        
        <a href="../cluster-autoscaling/" class="md-footer__link md-footer__link--next" aria-label="Next: Cluster-Autoscaler" rel="next">
          <div class="md-footer__title">
            <div class="md-ellipsis">
              <span class="md-footer__direction">
                Next
              </span>
              Cluster-Autoscaler
            </div>
          </div>
          <div class="md-footer__button md-icon">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M4 11v2h12l-5.5 5.5 1.42 1.42L19.84 12l-7.92-7.92L10.5 5.5 16 11H4Z"/></svg>
          </div>
        </a>
      
    </nav>
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    <script id="__config" type="application/json">{"base": "..", "features": ["tabs"], "search": "../assets/javascripts/workers/search.5bf1dace.min.js", "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.config.lang": "en", "search.config.pipeline": "trimmer, stopWordFilter", "search.config.separator": "[\\s\\-]+", "search.placeholder": "Search", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version.title": "Select version"}}</script>
    
    
      <script src="../assets/javascripts/bundle.37e9125f.min.js"></script>
      
    
  </body>
</html>