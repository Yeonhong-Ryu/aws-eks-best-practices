
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
      <link rel="icon" href="../../../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.4.0, mkdocs-material-8.5.3">
    
    
      
        <title>Load Balancing - EKS Best Practices Guides</title>
      
    
    
      <link rel="stylesheet" href="../../../assets/stylesheets/main.7a952b86.min.css">
      
        
        <link rel="stylesheet" href="../../../assets/stylesheets/palette.cbb835fc.min.css">
        
      
      

    
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
    <script>__md_scope=new URL("../../..",location),__md_hash=e=>[...e].reduce((e,_)=>(e<<5)-e+_.charCodeAt(0),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      
  


  
  


  <script id="__analytics">function __md_analytics(){function n(){dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],n("js",new Date),n("config","G-VQGL8B2FH8"),document.addEventListener("DOMContentLoaded",function(){document.forms.search&&document.forms.search.query.addEventListener("blur",function(){this.value&&n("event","search",{search_term:this.value})}),document$.subscribe(function(){var a=document.forms.feedback;if(void 0!==a)for(var e of a.querySelectorAll("[type=submit]"))e.addEventListener("click",function(e){e.preventDefault();var t=document.location.pathname,e=this.getAttribute("data-md-value");n("event","feedback",{page:t,data:e}),a.firstElementChild.disabled=!0;e=a.querySelector(".md-feedback__note [data-md-value='"+e+"']");e&&(e.hidden=!1)}),a.hidden=!1}),location$.subscribe(function(e){n("config","G-VQGL8B2FH8",{page_path:e.pathname})})});var e=document.createElement("script");e.async=!0,e.src="https://www.googletagmanager.com/gtag/js?id=G-VQGL8B2FH8",document.getElementById("__analytics").insertAdjacentElement("afterEnd",e)}</script>

  
    <script>"undefined"!=typeof __md_analytics&&__md_analytics()</script>
  

    
    
    
  </head>
  
  
    
    
    
    
    
    <body dir="ltr" data-md-color-scheme="" data-md-color-primary="none" data-md-color-accent="none">
  
    
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#avoiding-errors-timeouts-with-kubernetes-applications-and-aws-load-balancers" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

<header class="md-header" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href="../../.." title="EKS Best Practices Guides" class="md-header__button md-logo" aria-label="EKS Best Practices Guides" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54Z"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2Z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            EKS Best Practices Guides
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              Load Balancing
            
          </span>
        </div>
      </div>
    </div>
    
    
    
      <label class="md-header__button md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
      </label>
      <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41Z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
      <div class="md-header__source">
        <a href="https://github.com/aws/aws-eks-best-practices" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 496 512"><!--! Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc.--><path d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6zm-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3zm44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9zM244.8 8C106.1 8 0 113.3 0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8zM97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1zm-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7zm32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1zm-11.4-14.7c-1.6 1-1.6 3.6 0 5.9 1.6 2.3 4.3 3.3 5.6 2.3 1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2z"/></svg>
  </div>
  <div class="md-source__repository">
    aws/aws-eks-best-practices
  </div>
</a>
      </div>
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    


<nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../../.." title="EKS Best Practices Guides" class="md-nav__button md-logo" aria-label="EKS Best Practices Guides" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54Z"/></svg>

    </a>
    EKS Best Practices Guides
  </label>
  
    <div class="md-nav__source">
      <a href="https://github.com/aws/aws-eks-best-practices" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 496 512"><!--! Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc.--><path d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6zm-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3zm44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9zM244.8 8C106.1 8 0 113.3 0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8zM97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1zm-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7zm32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1zm-11.4-14.7c-1.6 1-1.6 3.6 0 5.9 1.6 2.3 4.3 3.3 5.6 2.3 1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2z"/></svg>
  </div>
  <div class="md-source__repository">
    aws/aws-eks-best-practices
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_1" type="checkbox" id="__nav_1" >
      
      
      
      
        <label class="md-nav__link" for="__nav_1">
          Guides
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Guides" data-md-level="1">
        <label class="md-nav__title" for="__nav_1">
          <span class="md-nav__icon md-icon"></span>
          Guides
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../.." class="md-nav__link">
        Introduction
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_2" type="checkbox" id="__nav_2" >
      
      
      
      
        <label class="md-nav__link" for="__nav_2">
          Security
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Security" data-md-level="1">
        <label class="md-nav__title" for="__nav_2">
          <span class="md-nav__icon md-icon"></span>
          Security
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../security/docs/" class="md-nav__link">
        Home
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../security/docs/iam/" class="md-nav__link">
        Identity and Access Management
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../security/docs/pods/" class="md-nav__link">
        Pod Security
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../security/docs/multitenancy/" class="md-nav__link">
        Multi-tenancy
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../security/docs/detective/" class="md-nav__link">
        Detective Controls
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../security/docs/network/" class="md-nav__link">
        Network Security
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../security/docs/data/" class="md-nav__link">
        Data Encryption and Secrets Management
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../security/docs/runtime/" class="md-nav__link">
        Runtime Security
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../security/docs/hosts/" class="md-nav__link">
        Infrastructure Security
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../security/docs/compliance/" class="md-nav__link">
        Regulatory Compliance
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../security/docs/incidents/" class="md-nav__link">
        Incident Response and Forensics
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../security/docs/image/" class="md-nav__link">
        Image Security
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_3" type="checkbox" id="__nav_3" >
      
      
      
      
        <label class="md-nav__link" for="__nav_3">
          Cluster Autoscaling
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Cluster Autoscaling" data-md-level="1">
        <label class="md-nav__title" for="__nav_3">
          <span class="md-nav__icon md-icon"></span>
          Cluster Autoscaling
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../karpenter/" class="md-nav__link">
        Karpenter
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../cluster-autoscaling/" class="md-nav__link">
        Cluster-Autoscaler
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_4" type="checkbox" id="__nav_4" >
      
      
      
      
        <label class="md-nav__link" for="__nav_4">
          Reliability
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Reliability" data-md-level="1">
        <label class="md-nav__title" for="__nav_4">
          <span class="md-nav__icon md-icon"></span>
          Reliability
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../reliability/docs/" class="md-nav__link">
        Home
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../reliability/docs/application/" class="md-nav__link">
        Applications
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../reliability/docs/controlplane/" class="md-nav__link">
        Control Plane
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../reliability/docs/dataplane/" class="md-nav__link">
        Data Plane
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../reliability/docs/networkmanagement/" class="md-nav__link">
        Network
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_5" type="checkbox" id="__nav_5" >
      
      
      
      
        <label class="md-nav__link" for="__nav_5">
          Windows Containers
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Windows Containers" data-md-level="1">
        <label class="md-nav__title" for="__nav_5">
          <span class="md-nav__icon md-icon"></span>
          Windows Containers
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../windows/docs/ami/" class="md-nav__link">
        AMI Management
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../windows/docs/gmsa/" class="md-nav__link">
        gMSA for Windows Containers
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../windows/docs/hardening/" class="md-nav__link">
        Windows Server Hardening
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../windows/docs/heterogeneous/" class="md-nav__link">
        Running Mixed Workloads
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../windows/docs/images/" class="md-nav__link">
        Scanning Windows Images
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../windows/docs/licensing/" class="md-nav__link">
        Windows Versions and Licensing
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../windows/docs/logging/" class="md-nav__link">
        Logging
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../windows/docs/monitoring/" class="md-nav__link">
        Monitoring Windows Containers
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../windows/docs/networking/" class="md-nav__link">
        Windows Networking
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../windows/docs/oom/" class="md-nav__link">
        Memory and Systems Management
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../windows/docs/patching/" class="md-nav__link">
        Infrastructure Management
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../windows/docs/scheduling/" class="md-nav__link">
        Scheduling
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../windows/docs/security/" class="md-nav__link">
        Pod Security for Windows Containers
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../windows/docs/storage/" class="md-nav__link">
        Storage Options
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
    
  
  
    
    <li class="md-nav__item md-nav__item--active md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_6" type="checkbox" id="__nav_6" checked>
      
      
      
      
        <label class="md-nav__link" for="__nav_6">
          Networking
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Networking" data-md-level="1">
        <label class="md-nav__title" for="__nav_6">
          <span class="md-nav__icon md-icon"></span>
          Networking
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../index/" class="md-nav__link">
        Home
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../subnets/" class="md-nav__link">
        VPC and Subnet Considerations
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../vpc-cni/" class="md-nav__link">
        Amazon VPC CNI
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../prefix-mode/" class="md-nav__link">
        Prefix Mode
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../ipv6/" class="md-nav__link">
        Running IPv6 Clusters
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../sgpp/" class="md-nav__link">
        Security Groups per Pod
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../custom-networking/" class="md-nav__link">
        Custom Networking
      </a>
    </li>
  

            
          
            
              
  
  
    
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" data-md-toggle="toc" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          Load Balancing
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        Load Balancing
      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#pod-readiness" class="md-nav__link">
    Pod Readiness
  </a>
  
    <nav class="md-nav" aria-label="Pod Readiness">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#impact-on-deployments" class="md-nav__link">
    Impact on Deployments
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#recommendations" class="md-nav__link">
    Recommendations
  </a>
  
    <nav class="md-nav" aria-label="Recommendations">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#use-ip-target-type-load-balancers" class="md-nav__link">
    Use IP Target-Type Load Balancers
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#utilize-pod-readiness-gates" class="md-nav__link">
    Utilize Pod Readiness Gates
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ensure-pods-are-deregistered-from-load-balancers-before-termination" class="md-nav__link">
    Ensure Pods are Deregistered from Load Balancers before Termination
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ensure-pods-have-readiness-probes" class="md-nav__link">
    Ensure Pods have Readiness Probes
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#configure-a-pod-disruption-budget" class="md-nav__link">
    Configure a Pod Disruption Budget
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#gracefully-handle-termination-signals" class="md-nav__link">
    Gracefully handle Termination Signals
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#be-wary-of-the-deregistration-delay" class="md-nav__link">
    Be Wary of the Deregistration Delay
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#pod-readiness" class="md-nav__link">
    Pod Readiness
  </a>
  
    <nav class="md-nav" aria-label="Pod Readiness">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#impact-on-deployments" class="md-nav__link">
    Impact on Deployments
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#recommendations" class="md-nav__link">
    Recommendations
  </a>
  
    <nav class="md-nav" aria-label="Recommendations">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#use-ip-target-type-load-balancers" class="md-nav__link">
    Use IP Target-Type Load Balancers
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#utilize-pod-readiness-gates" class="md-nav__link">
    Utilize Pod Readiness Gates
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ensure-pods-are-deregistered-from-load-balancers-before-termination" class="md-nav__link">
    Ensure Pods are Deregistered from Load Balancers before Termination
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ensure-pods-have-readiness-probes" class="md-nav__link">
    Ensure Pods have Readiness Probes
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#configure-a-pod-disruption-budget" class="md-nav__link">
    Configure a Pod Disruption Budget
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#gracefully-handle-termination-signals" class="md-nav__link">
    Gracefully handle Termination Signals
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#be-wary-of-the-deregistration-delay" class="md-nav__link">
    Be Wary of the Deregistration Delay
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  

  <a href="https://github.com/aws/aws-eks-best-practices/edit/master/docs/networking/loadbalancing/loadbalancing.md" title="Edit this page" class="md-content__button md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20.71 7.04c.39-.39.39-1.04 0-1.41l-2.34-2.34c-.37-.39-1.02-.39-1.41 0l-1.84 1.83 3.75 3.75M3 17.25V21h3.75L17.81 9.93l-3.75-3.75L3 17.25Z"/></svg>
  </a>


<h1 id="avoiding-errors-timeouts-with-kubernetes-applications-and-aws-load-balancers">Avoiding Errors &amp; Timeouts with Kubernetes Applications and AWS Load Balancers<a class="headerlink" href="#avoiding-errors-timeouts-with-kubernetes-applications-and-aws-load-balancers" title="Permanent link">&para;</a></h1>
<p>After creating the necessary Kubernetes resources (Service, Deployment, Ingress, etc), your pods should be able to receive traffic from your clients through an Elastic Load Balancer. However, you may find that errors, timeouts, or connection resets are being generated when you make changes to the application or Kubernetes environment. Those changes could trigger an application deployment or a scaling action (either manual or automatic).</p>
<p>Unfortunately, those errors may be generated even when your application is not logging problems. This is because the Kubernetes systems controlling the resources in your cluster may be running faster than the AWS systems that control the Load Balancer's target registration and health. Your Pods may also start receiving traffic before your application is ready to receive requests.</p>
<p>Lets review the process through which a pod becomes Ready and how traffic can be routed into the pods.</p>
<h2 id="pod-readiness">Pod Readiness<a class="headerlink" href="#pod-readiness" title="Permanent link">&para;</a></h2>
<p>This diagram from a <a href="https://www.youtube.com/watch?v=Vw9GmSeomFg">2019 Kubecon talk</a>, shows the steps taken for a pod to become Ready and receive traffic for a <code>LoadBalancer</code> service:
<img alt="readiness.png" src="../readiness.png" />
<em><a href="https://www.youtube.com/watch?v=Vw9GmSeomFg">Ready? A Deep Dive into Pod Readiness Gates for Service Health... - Minhan Xia &amp; Ping Zou</a></em><br />
When a pod that is a member of a NodePort Service is created, Kubernetes will go through the following steps:</p>
<ol>
<li>The pod is created on the Kubernetes control plane (i.e. from a <code>kubectl</code> command or scaling action).</li>
<li>The pod is scheduled by the <code>kube-scheduler</code> and is assigned to a node in the cluster. </li>
<li>The kubelet running on the assigned node will receive the update (via <code>watch</code>) and will communicate with it’s local Container Runtime to start the containers specified in the pod. <ol>
<li>When the containers have started running (and optionally pass <code>ReadinessProbes</code>), the kubelet will update the pod status to <code>Ready</code> by sending an update to the <code>kube-apiserver</code></li>
</ol>
</li>
<li>The Endpoint Controller will receive an update (via <code>watch</code>) that there is a new pod that is <code>Ready</code> to be added to the Endpoints list for the Service and will add the pod IP/Port tuples to the appropriate endpoints array.</li>
<li><code>kube-proxy</code> receives an update (via <code>watch</code>) that there is a new IP/Port to add to the iptables rules for the Service.<ol>
<li>The local iptables rules on the worker node will be updated with the additional target pod for the NodePort Service.</li>
</ol>
</li>
</ol>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>When using an Ingress resource and Ingress Controller (like the AWS Load Balancer Controller) step 5 is handled by the relevant controller instead of <code>kube-proxy</code>. The controller will then take the necessary configuration steps (such as registering/deregistering the target to a load balancer) to allow traffic to flow as expected.</p>
</div>
<p><a href="https://kubernetes.io/docs/concepts/workloads/pods/pod-lifecycle/#pod-termination">When a pod is terminated</a>, or changes to a not-ready state, a similar process occurs. The API server will receive either an update from a controller, kubelet, or kubectl client to terminate the pod. Steps 3-5 continue from there but will remove the Pod IP/Tuple from the endpoints list and iptables rules rather than insert.</p>
<h3 id="impact-on-deployments">Impact on Deployments<a class="headerlink" href="#impact-on-deployments" title="Permanent link">&para;</a></h3>
<p>Below is a diagram showing the steps taken when an application deployment triggers the replacement of pods:
<img alt="deployments.png" src="../deployments.png" />
<em><a href="https://www.youtube.com/watch?v=Vw9GmSeomFg">Ready? A Deep Dive into Pod Readiness Gates for Service Health... - Minhan Xia &amp; Ping Zou</a></em><br />
Of note in this diagram is that the second Pod will not be deployed until the first pod has reached the “Ready” state. Steps 4 and 5 from the previous section will also happen in parallel with the deployment actions above.</p>
<p>This means that the actions to propagate the new pod status may still be in-progress when the Deployment controller moves on to the next pods. Since this process also terminates the older version of pods, this could lead to a situation where the pods have reached a Ready status but those changes are still being propagated and the older versions of the pod have been terminated. </p>
<p>This problem is exacerbated when working with load balancers from Cloud Providers like AWS as the Kubernetes systems described above do not, by default, take into account registration times or health checks on the Load Balancer. <strong>This means the Deployment update could completely cycle through the pods, but the Load Balancer has not finished performing the health checks or registrating the new Pods which could cause an outage.</strong></p>
<p>A similar problem occurs when a pod is terminated. Depending on the Load Balancer configuration the Pod may take a minute or two to deregister and stop taking new requests. <strong>Kubernetes does not delay rolling deployments for this deregistration, this can lead to a state where the Load Balancer is still sending traffic to the IP/port for a target Pod that has already been terminated.</strong></p>
<p>To avoid these problems we can add configuration to ensure the Kubernetes systems take actions more in line with the AWS Load Balancer behavior.</p>
<h2 id="recommendations">Recommendations<a class="headerlink" href="#recommendations" title="Permanent link">&para;</a></h2>
<h3 id="use-ip-target-type-load-balancers">Use IP Target-Type Load Balancers<a class="headerlink" href="#use-ip-target-type-load-balancers" title="Permanent link">&para;</a></h3>
<p>When creating a <code>LoadBalancer</code> type service the traffic is sent from the load balancer to <em>any node in the cluster</em> via <strong>Instance target type</strong> registration. Each node then redirects the traffic from the <code>NodePort</code> to a Pod/IP tuple in the Service’s Endpoints array, this target could be running on a separate worker node</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Remember that array should only have “Ready” pods</p>
</div>
<p><img alt="nodeport.png" src="../nodeport.png" /></p>
<p>This adds an additional hop to your request, and adds complexity to the Load Balancer configuration. For example, if the Load Balancer above was configured with session affinity, that affinity could only hold between the load balancer and the backend node (depending on the affinity configuration). </p>
<p>Since the Load Balancer is not communicating with the backend Pod directly, controlling the traffic flow and timing with the Kubernetes systems becomes more difficult.</p>
<p>When using the <a href="https://github.com/kubernetes-sigs/aws-load-balancer-controller">AWS Load Balancer Controller</a>, <strong>IP target type</strong> can be used to register the Pod IP/Port tuples with the Load Balancer directly:
<img alt="ip.png" src="../ip.png" /><br />
This simplifies the traffic path from the Load Balancer to the target Pods. This means when a new target is registered we can be sure that target is a “Ready” Pod IP and port, the health checks from the load balancer will hit the Pod Directly, and when reviewing VPC flow logs or monitoring utilities traffic between the Load Balancer and the Pods will be easily traceable.</p>
<p>Using IP registration also allows us to control the timing and configuration of the traffic directly against the backend Pods, rather than trying to manage connections through the <code>NodePort</code> rules as well.</p>
<h3 id="utilize-pod-readiness-gates">Utilize Pod Readiness Gates<a class="headerlink" href="#utilize-pod-readiness-gates" title="Permanent link">&para;</a></h3>
<p><a href="https://kubernetes.io/docs/concepts/workloads/pods/pod-lifecycle/#pod-readiness-gate">Pod Readiness Gates</a> are additional requirements that must be met before the Pod is allowed to reach the “Ready” state.</p>
<blockquote>
<p><a href="https://kubernetes-sigs.github.io/aws-load-balancer-controller/v2.4/deploy/pod_readiness_gate/">[...] the AWS Load Balancer controller can set the readiness condition on the pods that constitute your ingress or service backend. The condition status on a pod will be set to <code>True</code> only when the corresponding target in the ALB/NLB target group shows a health state of »Healthy«. This prevents the rolling update of a deployment from terminating old pods until the newly created pods are »Healthy« in the ALB/NLB target group and ready to take traffic.</a></p>
</blockquote>
<p>The readiness gates ensure that Kubernetes doesn’t move “too fast” when creating new replicas during a deployment and avoids the situation where Kubernetes has completed the deployment but the new Pods have not completed registration.</p>
<p>To enable these you will need to:</p>
<ol>
<li>Deploy the latest version of the <a href="https://github.com/kubernetes-sigs/aws-load-balancer-controller">AWS Load Balancer Controller</a> (<strong><a href="https://kubernetes-sigs.github.io/aws-load-balancer-controller/v2.4/deploy/upgrade/migrate_v1_v2/"><em>Refer to the documentation if upgrading older versions</em></a></strong>)</li>
<li><a href="https://kubernetes-sigs.github.io/aws-load-balancer-controller/v2.4/deploy/pod_readiness_gate/">Label the namespace where the target pods are running</a> with the <code>elbv2.k8s.aws/pod-readiness-gate-inject: enabled</code> label to inject Pod Readiness Gates automatically.</li>
<li>To ensure all of your pods in a namespace get the readiness gate config, you need create your Ingress or Service and label the namespace <strong><em>before</em></strong> creating the pods.</li>
</ol>
<h3 id="ensure-pods-are-deregistered-from-load-balancers-before-termination">Ensure Pods are Deregistered from Load Balancers <em>before</em> Termination<a class="headerlink" href="#ensure-pods-are-deregistered-from-load-balancers-before-termination" title="Permanent link">&para;</a></h3>
<p>When a pod is terminated steps 4 and 5 from the pod readiness section occur at the same time that the container processes receive the termination signals. This means that if your container is able to shut down quickly it may shut down faster than the Load Balancer is able to deregister the target. To avoid this situation adjust the Pod spec with:</p>
<ol>
<li>Add a <code>preStop</code> lifecycle hook to allow the application to deregister and gracefully close connections. This hook is called immediately before a container is terminated due to an API request or management event such as a liveness/startup probe failure, preemption, resource contention and others. Critically, <a href="https://kubernetes.io/docs/concepts/workloads/pods/pod-lifecycle/#pod-termination">this hook is called and allowed to complete <strong>before</strong> the termination signals are sent</a>, provided the grace period is long enough to accommodate the execution.</li>
</ol>
<div class="codehilite"><pre><span></span><code><span class="w">        </span><span class="nv">lifecycle</span>:<span class="w"></span>
<span class="w">          </span><span class="nv">preStop</span>:<span class="w"></span>
<span class="w">            </span><span class="k">exec</span>:<span class="w"></span>
<span class="w">              </span><span class="nv">command</span>:<span class="w"> </span>[<span class="s2">&quot;/bin/sh&quot;</span>,<span class="w"> </span><span class="s2">&quot;-c&quot;</span>,<span class="w"> </span><span class="s2">&quot;sleep 180&quot;</span>]<span class="w"> </span>
</code></pre></div>

<p>A simple sleep command like the one above can be used to introduce a short delay between when the pod is marked <code>Terminating</code> (and Load Balancer deregistration begins) and when the termination signal is sent to the container process. If needed this hook can also be leveraged for more advanced application termination/shutdown procedures.</p>
<ol>
<li>Extend the <code>terminationGracePeriodSeconds</code> to accommodate the entire <code>prestop</code> execution time, as well as the time your application takes to gracefully respond to the termination signal. In the example below the grace period is extended to 200s which allows the entire <code>sleep 180</code> command to complete and then an extra 20s just to be sure my app can shutdown gracefully.</li>
</ol>
<div class="codehilite"><pre><span></span><code><span class="w">    </span><span class="nv">spec</span>:<span class="w"></span>
<span class="w">      </span><span class="nv">terminationGracePeriodSeconds</span>:<span class="w"> </span><span class="mi">200</span><span class="w"></span>
<span class="w">      </span><span class="nv">containers</span>:<span class="w"></span>
<span class="w">      </span><span class="o">-</span><span class="w"> </span><span class="nv">name</span>:<span class="w"> </span><span class="nv">webapp</span><span class="w"></span>
<span class="w">        </span><span class="nv">image</span>:<span class="w"> </span><span class="nv">webapp</span><span class="o">-</span><span class="nv">st</span>:<span class="nv">v1</span>.<span class="mi">3</span><span class="w"></span>
<span class="w">        </span>[...]<span class="w"></span>
<span class="w">        </span><span class="nv">lifecycle</span>:<span class="w"></span>
<span class="w">          </span><span class="nv">preStop</span>:<span class="w"></span>
<span class="w">            </span><span class="k">exec</span>:<span class="w"></span>
<span class="w">              </span><span class="nv">command</span>:<span class="w"> </span>[<span class="s2">&quot;/bin/sh&quot;</span>,<span class="w"> </span><span class="s2">&quot;-c&quot;</span>,<span class="w"> </span><span class="s2">&quot;sleep 180&quot;</span>]<span class="w"> </span>
</code></pre></div>

<h3 id="ensure-pods-have-readiness-probes">Ensure Pods have Readiness Probes<a class="headerlink" href="#ensure-pods-have-readiness-probes" title="Permanent link">&para;</a></h3>
<p>When creating Pods in Kubernetes the default Readiness state is “Ready”, however most applications take a moment or two to instantiate and become ready for requests. <a href="https://kubernetes.io/docs/tasks/configure-pod-container/configure-liveness-readiness-startup-probes/">You can define a <code>readinessProbe</code> in the Pod spec</a> with an exec command or network request that is used to determine if the application has completed its start up and is ready for traffic. </p>
<p>Pods that are created with a <code>readinessProbe</code> defined start in a “NotReady” state, and only change to “Ready” when the <code>readinessProbe</code> is successful. This ensures that applications are not put “in-service” until the application has completed startup.</p>
<p>Liveness probes are recommended to allow for application restarts when entering a broken state, e.g. deadlocks, however care should be taken with stateful applications as liveness failures will trigger a restart of the application. <a href="https://kubernetes.io/docs/tasks/configure-pod-container/configure-liveness-readiness-startup-probes/#define-startup-probes">Startup probes</a> can also be leveraged for applications that are slow to start.</p>
<p>The below probes use HTTP probes against port 80 to check when the web application becomes ready (the same probe configuration is also used for the liveness probe):</p>
<div class="codehilite"><pre><span></span><code>        [...]
        ports:
        - containerPort: 80
        livenessProbe:
          httpGet:
            path: /
            port: 80
          failureThreshold: 1
          periodSeconds: 10
          initialDelaySeconds: 5
        readinessProbe:
          httpGet:
            path: /
            port: 80
          periodSeconds: 5
        [...]
</code></pre></div>

<h3 id="configure-a-pod-disruption-budget">Configure a Pod Disruption Budget<a class="headerlink" href="#configure-a-pod-disruption-budget" title="Permanent link">&para;</a></h3>
<p>A <a href="https://kubernetes.io/docs/concepts/workloads/pods/disruptions/#pod-disruption-budgets">Pod Disruption Budget (PDB)</a> limits the number of Pods of a replicated application that are down simultaneously from <a href="https://kubernetes.io/docs/concepts/workloads/pods/disruptions/#voluntary-and-involuntary-disruptions">voluntary disruptions</a>. For example, a quorum-based application would like to ensure that the number of replicas running is never brought below the number needed for a quorum. A web front end might want to ensure that the number of replicas serving load never falls below a certain percentage of the total.</p>
<p>The PDB will protect the application against things like the nodes being drained, or application deployments. The PDB ensures that a minimum number or percentage of pods remain available while taking these actions. </p>
<div class="admonition attention">
<p class="admonition-title">Attention</p>
<p>PDB’s will NOT protect the application against involuntary disruptions like a failure in the host OS or loss of network connectivity. </p>
</div>
<p>The example below ensures that there is always at least 1 Pod available with the label <code>app: echoserver</code>. <a href="https://kubernetes.io/docs/tasks/run-application/configure-pdb/#think-about-how-your-application-reacts-to-disruptions">You can configure the correct replica count for your application or use a percentage</a>:</p>
<div class="codehilite"><pre><span></span><code><span class="n">apiVersion</span><span class="o">:</span><span class="w"> </span><span class="n">policy</span><span class="o">/</span><span class="n">v1beta1</span><span class="w"></span>
<span class="n">kind</span><span class="o">:</span><span class="w"> </span><span class="n">PodDisruptionBudget</span><span class="w"></span>
<span class="n">metadata</span><span class="o">:</span><span class="w"></span>
<span class="w">  </span><span class="n">name</span><span class="o">:</span><span class="w"> </span><span class="n">echoserver</span><span class="o">-</span><span class="n">pdb</span><span class="w"></span>
<span class="w">  </span><span class="kd">namespace</span><span class="o">:</span><span class="w"> </span><span class="n">echoserver</span><span class="w"></span>
<span class="n">spec</span><span class="o">:</span><span class="w"></span>
<span class="w">  </span><span class="n">minAvailable</span><span class="o">:</span><span class="w"> </span><span class="mi">1</span><span class="w"></span>
<span class="w">  </span><span class="n">selector</span><span class="o">:</span><span class="w"></span>
<span class="w">    </span><span class="n">matchLabels</span><span class="o">:</span><span class="w"></span>
<span class="w">      </span><span class="n">app</span><span class="o">:</span><span class="w"> </span><span class="n">echoserver</span><span class="w"></span>
</code></pre></div>

<h3 id="gracefully-handle-termination-signals">Gracefully handle Termination Signals<a class="headerlink" href="#gracefully-handle-termination-signals" title="Permanent link">&para;</a></h3>
<p>When a pod is Terminated the application running inside the container will receive two <a href="https://www.gnu.org/software/libc/manual/html_node/Standard-Signals.html">Signals</a>. The first is the <a href="https://www.gnu.org/software/libc/manual/html_node/Termination-Signals.html"><code>SIGTERM</code> signal</a>, which is a “polite” request that the process cease execution. This signal can be blocked or the application could simply ignore this signal, so after the <code>terminationGracePeriodSeconds</code> has elapsed the application will receive the <a href="https://www.gnu.org/software/libc/manual/html_node/Termination-Signals.html"><code>SIGKILL</code> signal</a>. <code>SIGKILL</code> is used to forcibly stop a process, it cannot be <a href="https://man7.org/linux/man-pages/man7/signal.7.html">blocked, handled or ignored</a>, and is therefore always fatal.</p>
<p>These Signals are used by the container runtime to trigger your application to shutdown. The <code>SIGTERM</code> signal will also be sent <strong>after</strong> the <code>preStop</code> hook has executed. With the above configuration the <code>preStop</code> hook will ensure the pod has been deregistered from the Load Balancer, so the application can then gracefully closes any remaining open connections when the <code>SIGTERM</code> signal is received. </p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p><a href="https://petermalmgren.com/signal-handling-docker/">Signal handling in container environments can be complicated when using “wrapper scripts” for the entrypoint of your application</a> as the script will be PID 1 and may not forward the signal to your application.</p>
</div>
<h3 id="be-wary-of-the-deregistration-delay">Be Wary of the Deregistration Delay<a class="headerlink" href="#be-wary-of-the-deregistration-delay" title="Permanent link">&para;</a></h3>
<p>Elastic Load Balancing stops sending requests to targets that are deregistering. By default, Elastic Load Balancing waits 300 seconds before completing the deregistration process, which can help in-flight requests to the target to complete. To change the amount of time that Elastic Load Balancing waits, update the deregistration delay value.
The initial state of a deregistering target is <code>draining</code>. After the deregistration delay elapses, the deregistration process completes and the state of the target is <code>unused</code>. If the target is part of an Auto Scaling group, it can be terminated and replaced.</p>
<p>If a deregistering target has no in-flight requests and no active connections, Elastic Load Balancing immediately completes the deregistration process, without waiting for the deregistration delay to elapse. </p>
<div class="admonition attention">
<p class="admonition-title">Attention</p>
<p>Even though target deregistration is complete, the status of the target is displayed as <code>draining</code> until the deregistration delay timeout expires. After the timeout expires, the target transitions to an <code>unused</code> state.</p>
</div>
<p><a href="https://docs.aws.amazon.com/elasticloadbalancing/latest/application/load-balancer-target-groups.html#deregistration-delay">If a deregistering target terminates the connection before the deregistration delay elapses, the client receives a 500-level error response</a>.</p>
<p>This can be configured using annotations on the Ingress resource using the<a href="https://kubernetes-sigs.github.io/aws-load-balancer-controller/v2.4/guide/ingress/annotations/#target-group-attributes"><code>alb.ingress.kubernetes.io/target-group-attributes</code> annotation</a>. Example:</p>
<div class="codehilite"><pre><span></span><code><span class="n">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="n">networking</span><span class="o">.</span><span class="n">k8s</span><span class="o">.</span><span class="n">io</span><span class="o">/</span><span class="n">v1</span><span class="w"></span>
<span class="n">kind</span><span class="p">:</span><span class="w"> </span><span class="n">Ingress</span><span class="w"></span>
<span class="n">metadata</span><span class="p">:</span><span class="w"></span>
<span class="w">  </span><span class="n">name</span><span class="p">:</span><span class="w"> </span><span class="n">echoserver</span><span class="o">-</span><span class="n">ip</span><span class="w"></span>
<span class="w">  </span><span class="n">namespace</span><span class="p">:</span><span class="w"> </span><span class="n">echoserver</span><span class="w"></span>
<span class="w">  </span><span class="n">annotations</span><span class="p">:</span><span class="w"></span>
<span class="w">    </span><span class="n">alb</span><span class="o">.</span><span class="n">ingress</span><span class="o">.</span><span class="n">kubernetes</span><span class="o">.</span><span class="n">io</span><span class="o">/</span><span class="n">scheme</span><span class="p">:</span><span class="w"> </span><span class="n">internet</span><span class="o">-</span><span class="n">facing</span><span class="w"></span>
<span class="w">    </span><span class="n">alb</span><span class="o">.</span><span class="n">ingress</span><span class="o">.</span><span class="n">kubernetes</span><span class="o">.</span><span class="n">io</span><span class="o">/</span><span class="n">target</span><span class="o">-</span><span class="n">type</span><span class="p">:</span><span class="w"> </span><span class="n">ip</span><span class="w"></span>
<span class="w">    </span><span class="n">alb</span><span class="o">.</span><span class="n">ingress</span><span class="o">.</span><span class="n">kubernetes</span><span class="o">.</span><span class="n">io</span><span class="o">/</span><span class="nb">load</span><span class="o">-</span><span class="n">balancer</span><span class="o">-</span><span class="n">name</span><span class="p">:</span><span class="w"> </span><span class="n">echoserver</span><span class="o">-</span><span class="n">ip</span><span class="w"></span>
<span class="w">    </span><span class="n">alb</span><span class="o">.</span><span class="n">ingress</span><span class="o">.</span><span class="n">kubernetes</span><span class="o">.</span><span class="n">io</span><span class="o">/</span><span class="n">target</span><span class="o">-</span><span class="n">group</span><span class="o">-</span><span class="n">attributes</span><span class="p">:</span><span class="w"> </span><span class="n">deregistration_delay</span><span class="o">.</span><span class="n">timeout_seconds</span><span class="o">=</span><span class="mi">30</span><span class="w"></span>
<span class="n">spec</span><span class="p">:</span><span class="w"></span>
<span class="w">  </span><span class="n">ingressClassName</span><span class="p">:</span><span class="w"> </span><span class="n">alb</span><span class="w"></span>
<span class="w">  </span><span class="n">rules</span><span class="p">:</span><span class="w"></span>
<span class="w">    </span><span class="o">-</span><span class="w"> </span><span class="n">host</span><span class="p">:</span><span class="w"> </span><span class="n">echoserver</span><span class="o">.</span><span class="n">example</span><span class="o">.</span><span class="n">com</span><span class="w"></span>
<span class="w">      </span><span class="n">http</span><span class="p">:</span><span class="w"></span>
<span class="w">        </span><span class="n">paths</span><span class="p">:</span><span class="w"></span>
<span class="w">          </span><span class="o">-</span><span class="w"> </span><span class="n">path</span><span class="p">:</span><span class="w"> </span><span class="o">/</span><span class="w"></span>
<span class="w">            </span><span class="n">pathType</span><span class="p">:</span><span class="w"> </span><span class="n">Exact</span><span class="w"></span>
<span class="w">            </span><span class="n">backend</span><span class="p">:</span><span class="w"></span>
<span class="w">              </span><span class="n">service</span><span class="p">:</span><span class="w"></span>
<span class="w">                </span><span class="n">name</span><span class="p">:</span><span class="w"> </span><span class="n">echoserver</span><span class="o">-</span><span class="n">service</span><span class="w"></span>
<span class="w">                </span><span class="n">port</span><span class="p">:</span><span class="w"></span>
<span class="w">                  </span><span class="n">number</span><span class="p">:</span><span class="w"> </span><span class="mi">8080</span><span class="w"></span>
</code></pre></div>


  




                
              </article>
            </div>
          
          
        </div>
        
      </main>
      
        <footer class="md-footer">
  
    
    <nav class="md-footer__inner md-grid" aria-label="Footer" >
      
        
        <a href="../../custom-networking/" class="md-footer__link md-footer__link--prev" aria-label="Previous: Custom Networking" rel="prev">
          <div class="md-footer__button md-icon">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"/></svg>
          </div>
          <div class="md-footer__title">
            <div class="md-ellipsis">
              <span class="md-footer__direction">
                Previous
              </span>
              Custom Networking
            </div>
          </div>
        </a>
      
      
    </nav>
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    <script id="__config" type="application/json">{"base": "../../..", "features": ["tabs"], "search": "../../../assets/javascripts/workers/search.5bf1dace.min.js", "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.config.lang": "en", "search.config.pipeline": "trimmer, stopWordFilter", "search.config.separator": "[\\s\\-]+", "search.placeholder": "Search", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version.title": "Select version"}}</script>
    
    
      <script src="../../../assets/javascripts/bundle.37e9125f.min.js"></script>
      
    
  </body>
</html>